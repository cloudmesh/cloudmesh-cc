<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cloudmesh.cc.workflow &mdash; cloudmesh-cc 4.3.7 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/readthedocs-custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> cloudmesh-cc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction.html">What Is Cloudmesh cc?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../abstract.html">Extended Abstract</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../manual/cc.html">Command cc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest-gui.html">REST GUI Web Browser Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../python.html">Python Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../specifying-workflows.html">Specifying Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../service.html">Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="openapi3.html#http://">OpenAPI</a></li>
<li class="toctree-l1"><a class="reference external" href="openapi.json#http://">OpenAPI (json)</a></li>
<li class="toctree-l1"><a class="reference external" href="openapi.yaml#http://">OpenAPI (yaml)</a></li>
<li class="toctree-l1"><a class="reference external" href="py-modindex.html#http://">Python API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../mnist.html">MNIST Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloudmask.html">Cloudmask Workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributors Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todos.html">Todo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../acknowledgements.html">Acknowledgments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">cloudmesh-cc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>cloudmesh.cc.workflow</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cloudmesh.cc.workflow</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Cloudmesh Workflow.</span>

<span class="sd">This class enables to manage dependencies between jobs.</span>
<span class="sd">To specify dependencies we can use a string that includes comma</span>
<span class="sd">separated names of jobs. The workflow can be stored into a yaml file::</span>

<span class="sd">    g = Graph()</span>
<span class="sd">    g.edges</span>
<span class="sd">    g.nodes</span>

<span class="sd">    g.add_edges(&quot;a,b,d&quot;)</span>
<span class="sd">    g.add_edges(&quot;a,c,d&quot;) # will also add missing nodes</span>

<span class="sd">    g.add_nodes(&quot;a&quot;, {&quot;status&quot;=&quot;ready&quot;})</span>
<span class="sd">    g.add_nodes(&quot;b&quot;, &quot;status&quot;=&quot;ready&quot;)    # will use dict update not eliminate other fields</span>

<span class="sd">    g.add_nodes(&quot;a,b,d&quot;, &quot;status&quot;=&quot;ready&quot;)</span>
<span class="sd">        # will add the nodes, but also update the internal attributes for the nodes,</span>
<span class="sd">        eg sets state to ready</span>

<span class="sd">    g.export(&quot;a.pdf&quot;)</span>

<span class="sd">A show function is available that allow the plotting of nodes with a default layout</span>
<span class="sd">and color values defined by a color map. By default a colormap for status with::</span>

<span class="sd">    ready = white</span>
<span class="sd">    failed = red</span>
<span class="sd">    running = blue</span>
<span class="sd">    done= green</span>

<span class="sd">is used. One has the ability to define color maps for any key that contains strings.</span>

<span class="sd">To for example change the status colors you could use::</span>

<span class="sd">    g.set_color(&quot;status&quot;,</span>
<span class="sd">                {&quot;ready&quot;: &quot;green&quot;,</span>
<span class="sd">                 &quot;failed&quot;: &quot;yellow&quot;,</span>
<span class="sd">                 &quot;running&quot;: &quot;orange&quot;,</span>
<span class="sd">                 &quot;done&quot;: &quot;white&quot;}</span>
<span class="sd">                 &quot;other&quot;: &quot;grey&quot;</span>
<span class="sd">                )</span>

<span class="sd">as you can see you can also define colors for other values that could be set in this case</span>
<span class="sd">for the node status. To display the graph you can say::</span>

<span class="sd">    g.show()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">graphviz</span>
<span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mpimg</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.Shell</span> <span class="kn">import</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.dotdict</span> <span class="kn">import</span> <span class="n">dotdict</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">path_expand</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">writefile</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">readfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.DateTime</span> <span class="kn">import</span> <span class="n">DateTime</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.Printer</span> <span class="kn">import</span> <span class="n">Printer</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">banner</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.systeminfo</span> <span class="kn">import</span> <span class="n">os_is_linux</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.systeminfo</span> <span class="kn">import</span> <span class="n">os_is_mac</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.systeminfo</span> <span class="kn">import</span> <span class="n">os_is_windows</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.systeminfo</span> <span class="kn">import</span> <span class="n">is_gitbash</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">cloudmesh.cc.labelmaker</span> <span class="kn">import</span> <span class="n">Labelmaker</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.variables</span> <span class="kn">import</span> <span class="n">Variables</span>


<div class="viewcode-block" id="Graph"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph">[docs]</a><span class="k">class</span> <span class="nc">Graph</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The Graph class handles the generation of workflow diagrams.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;graph&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the graph with characteristics such as edges, nodes and colors.</span>

<span class="sd">        :param name: name of the graph</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param filename: name of the file of the graph</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param clear: whether to reload from scratch</span>
<span class="sd">        :type clear: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">clear</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># maybe</span>
        <span class="c1"># config:</span>
        <span class="c1">#    name:</span>
        <span class="c1">#    colors:</span>

<div class="viewcode-block" id="Graph.clear"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reset the graph characteristics to a clean slate.</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">dotdict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_status_colors</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_count</span> <span class="o">=</span> <span class="mi">0</span></div>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the specified variable from the nodes.</span>

<span class="sd">        :param name: the variable to be retrieved</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: the specified variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="Graph.set_status_colors"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.set_status_colors">[docs]</a>    <span class="k">def</span> <span class="nf">set_status_colors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the ready, undefined, done, failed, and running colors as hex values.</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.add_color(&quot;status&quot;,</span>
        <span class="c1">#                ready=&quot;white&quot;,</span>
        <span class="c1">#                done=&quot;green&quot;,</span>
        <span class="c1">#                failed=&quot;red&quot;,</span>
        <span class="c1">#                running=&quot;blue&quot;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_color</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
                       <span class="n">ready</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
                       <span class="n">undefined</span><span class="o">=</span><span class="s2">&quot;#DBFF33&quot;</span><span class="p">,</span>
                       <span class="n">done</span><span class="o">=</span><span class="s2">&quot;#CCFFCC&quot;</span><span class="p">,</span>
                       <span class="n">failed</span><span class="o">=</span><span class="s2">&quot;#FFCCCC&quot;</span><span class="p">,</span>
                       <span class="n">running</span><span class="o">=</span><span class="s1">&#39;#CCE5FF&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.add_color"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.add_color">[docs]</a>    <span class="k">def</span> <span class="nf">add_color</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">**</span><span class="n">colors</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add specified color(s).</span>

<span class="sd">        :param key: the status whose color will be changed</span>
<span class="sd">        :type key: str</span>
<span class="sd">        :param colors: the colors to be added</span>
<span class="sd">        :type colors: kwargs</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">colors</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the graph in string format.</span>

<span class="sd">        :return: graph in string format</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;workflow&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">workflow</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<div class="viewcode-block" id="Graph.load"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a graph for a workflow.</span>

<span class="sd">        :param filename: the graph to load</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if filename is not None:</span>
        <span class="c1">#    raise NotImplementedError</span>
        <span class="c1"># should read from file the graph, but as we do Queues yaml dic</span>
        <span class="c1"># we do not need filename read right now</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Console.error(str(e), traceflag=True)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;workflow&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
             <span class="n">graph</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">][</span><span class="s2">&quot;dependencies&quot;</span><span class="p">]</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">graph</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">][</span><span class="s2">&quot;nodes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="o">**</span><span class="n">node</span><span class="p">)</span>


        <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.add_node"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.add_node">[docs]</a>    <span class="k">def</span> <span class="nf">add_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add node(s) to the graph.</span>

<span class="sd">        :param name: the name of the node</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param data: additional information related to node, like status</span>
<span class="sd">        :type data: kwargs</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="s2">&quot;label&quot;</span> <span class="ow">not</span> <span class="ow">in</span>  <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;format&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;number&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_count</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="Graph.add_edge"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.add_edge">[docs]</a>    <span class="k">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add edge(s) to the graph.</span>

<span class="sd">        :param source: beginning edge</span>
<span class="sd">        :type source: str</span>
<span class="sd">        :param destination: end edge</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :param data: additional information</span>
<span class="sd">        :type data: kwargs</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: add dependency to attribute in node dependency_in,</span>
        <span class="c1">#   dependency_out, we could use a set for that. so multiple</span>
        <span class="c1">#   dependencies are ignored</span>
        <span class="c1">#</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                <span class="s2">&quot;destination&quot;</span><span class="p">:</span> <span class="n">destination</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">destination</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">destination</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">source</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">source</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">destination</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.delete_edge"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.delete_edge">[docs]</a>    <span class="k">def</span> <span class="nf">delete_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add edge(s) to the graph.</span>

<span class="sd">        :param source: beginning edge</span>
<span class="sd">        :type source: str</span>
<span class="sd">        :param destination: end edge</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="c1"># TODO: add dependency to attribute in node dependency_in,</span>
        <span class="c1">#   dependency_out, we could use a set for that. so multiple</span>
        <span class="c1">#   dependencies are ignored</span>
        <span class="c1">#</span>
        <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">sep</span><span class="si">}{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

        <span class="c1"># TODO: do this somehow e.g. remove source from destination in parent</span>
        <span class="c1"># if &quot;parent&quot; not in self.nodes[destination]:</span>
        <span class="c1">#     self.nodes[destination][&quot;parent&quot;] = []</span>
        <span class="c1"># if &quot;parent&quot; not in self.nodes[source]:</span>
        <span class="c1">#     self.nodes[source][&quot;parent&quot;] = []</span>
        <span class="c1"># self.nodes[destination][&quot;parent&quot;].append(source)</span>

<div class="viewcode-block" id="Graph.delete_node"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.delete_node">[docs]</a>    <span class="k">def</span> <span class="nf">delete_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>

        <span class="k">pass</span></div>
        <span class="c1"># del self.node[name]</span>
        <span class="c1"># for all nodes:</span>
        <span class="c1">#     if parents of node containes name:</span>
        <span class="c1">#         remove the name from parents:</span>

<div class="viewcode-block" id="Graph.done"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.done">[docs]</a>    <span class="k">def</span> <span class="nf">done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove from all nodes the named parent.</span>

<span class="sd">        :param parent: originating node</span>
<span class="sd">        :type parent: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;parent&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.todo"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.todo">[docs]</a>    <span class="k">def</span> <span class="nf">todo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all nodes with no parents and progress != 100.</span>

<span class="sd">        :return: list of node names with no parents</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">100</span> <span class="ow">and</span> \
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;parent&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="k">pass</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Graph.set_status"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.set_status">[docs]</a>    <span class="k">def</span> <span class="nf">set_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the status of a specified node.</span>

<span class="sd">        :param name: node whose status will be changed</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param status: name of status to be set for the node</span>
<span class="sd">        :type status: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span></div>

<div class="viewcode-block" id="Graph.get_status"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.get_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve status of a specified node.</span>

<span class="sd">        :param name: node whose status will be retrieved</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: the status of the node</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Graph.add_dependency"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.add_dependency">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add dependency between source and destination.</span>

<span class="sd">        Add a dependency for a node. a dependency enforces</span>
<span class="sd">        the completion of a previous node in order for the</span>
<span class="sd">        next to be run.</span>

<span class="sd">        :param source: beginning node</span>
<span class="sd">        :type source: str</span>
<span class="sd">        :param destination: node that cannot run without the source</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.add_dependencies"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.add_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency</span><span class="p">,</span> <span class="n">nodedata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">edgedata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add multiple dependencies betwee several nodes.</span>

<span class="sd">        Add dependencies for nodes. a dependency enforces</span>
<span class="sd">        the completion of a previous node in order for the</span>
<span class="sd">        next to be run.</span>

<span class="sd">        An example is a,b,c,d which creates dependencies between</span>
<span class="sd">        a,b</span>
<span class="sd">        b,c</span>
<span class="sd">        c,d</span>
<span class="sd">        e.g. a-&gt;b-&gt;c-&gt;d</span>

<span class="sd">        :param dependency: a comma separated string with names of nodes</span>
<span class="sd">        :type dependency: str</span>
<span class="sd">        :param nodedata: specifications of the node such as status</span>
<span class="sd">        :type nodedata: kwargs</span>
<span class="sd">        :param edgedata: specifications of the edge</span>
<span class="sd">        :type edgedata: kwargs</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">dependency</span><span class="p">)</span>
        <span class="c1"># check if all nodes exists if not create the missing once</span>
        <span class="c1"># loop through all node pairs and create adges, as name for adges</span>
        <span class="c1"># you use {source}-{destination}</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nodedata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">**</span><span class="n">nodedata</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="n">nodes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">edgedata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="o">**</span><span class="n">edgedata</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.export"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.export">[docs]</a>    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;show,a.png,a.svg,a.pdf&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Export the graph.</span>

<span class="sd">        Take the inputted filename, expands it into list</span>
<span class="sd">        if commas and brackets are present, and saves the</span>
<span class="sd">        graph into specified filenames. this function seems</span>
<span class="sd">        to be incomplete.</span>

<span class="sd">        :param filename: names to save the graph to. if show, then shows graph</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># comma separated list of output files in one command</span>
        <span class="c1"># if show is included show() is used</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;show&quot;</span> <span class="o">==</span> <span class="n">filename</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.pdf&quot;</span><span class="p">):</span>
                <span class="k">pass</span></div>
            <span class="c1"># and so on</span>

<div class="viewcode-block" id="Graph.save_to_yaml"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.save_to_yaml">[docs]</a>    <span class="k">def</span> <span class="nf">save_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the graph.</span>

<span class="sd">        Save the graph to a specified filename and</span>
<span class="sd">        excludes nodes if exclude is specified.</span>
<span class="sd">        meant to be used to save as yaml, not svg.</span>

<span class="sd">        :param filename: name of file to save graph to</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param exclude: nodes to exclude from the saved file</span>
<span class="sd">        :type exclude: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># exclude parent</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">exclude</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
            <span class="n">g</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>
            <span class="n">g</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">node</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">writefile</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.create_label"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.create_label">[docs]</a>    <span class="k">def</span> <span class="nf">create_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the text to appear on a node in the graph.</span>

<span class="sd">        :param name: name of node to add text to.</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: the text that will appear on node in string format</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;label_format&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label_format&quot;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s2">&quot;label&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">replacement</span> <span class="o">=</span> <span class="n">Labelmaker</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">replacement</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">msg</span></div>

<div class="viewcode-block" id="Graph.save"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">filename</span><span class="o">=</span><span class="s2">&quot;test.svg&quot;</span><span class="p">,</span>
             <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">layout</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">,</span>
             <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;networkx&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate and saves the graph.</span>

<span class="sd">        :param filename: file to save the graph to</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param colors: colors to use for the graph</span>
<span class="sd">        :type colors:</span>
<span class="sd">        :param layout: layout of the graph</span>
<span class="sd">        :type layout:</span>
<span class="sd">        :param engine: name of engine to use to draw graph</span>
<span class="sd">        :type engine: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dot</span> <span class="o">=</span> <span class="n">graphviz</span><span class="o">.</span><span class="n">Digraph</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s1">&#39;Dot Graph&#39;</span><span class="p">)</span>
        <span class="c1"># dot.attr(rankdir=&#39;LR&#39;)</span>
        <span class="n">dot</span><span class="o">.</span><span class="n">attr</span><span class="p">(</span><span class="s1">&#39;node&#39;</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>

        <span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="n">color_map</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">color_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="n">colors</span><span class="p">]</span>
                <span class="n">color_map</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">value</span><span class="p">])</span>
                <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;shape&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;shape&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">]:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;diamond&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="s2">&quot;box&quot;</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

                <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;filled,rounded&#39;</span>
                <span class="k">if</span> <span class="s1">&#39;style&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;style&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">style</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                        <span class="n">style</span> <span class="o">=</span> <span class="s1">&#39;filled&#39;</span>

                <span class="n">dot</span><span class="o">.</span><span class="n">node</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
                         <span class="n">label</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                         <span class="c1"># color=self.colors[colors][value],</span>
                         <span class="n">style</span><span class="o">=</span><span class="n">style</span><span class="p">,</span>
                         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                         <span class="n">fillcolor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">value</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">])</span>
            <span class="n">dot</span><span class="o">.</span><span class="n">edge</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;dot&quot;</span><span class="p">:</span>
            <span class="n">basefilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="n">ending</span> <span class="o">=</span> <span class="n">basefilename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>

            <span class="n">dot_filename</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;.dot&quot;</span>
            <span class="n">dot_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">dot_filename</span><span class="p">)</span>
            <span class="n">writefile</span><span class="p">(</span><span class="n">dot_filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dot</span><span class="o">.</span><span class="n">source</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dot -T</span><span class="si">{</span><span class="n">ending</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">dot_filename</span><span class="si">}</span><span class="s2"> -o </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s2">&quot;graphviz&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">layout</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="n">with_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">color_map</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;pyplot&#39;</span><span class="p">:</span>

            <span class="c1"># generate dot graph</span>
            <span class="n">P</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">nx_pydot</span><span class="o">.</span><span class="n">to_pydot</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

            <span class="c1"># convert from `networkx` to a `pydot` graph</span>
            <span class="n">pydot_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">drawing</span><span class="o">.</span><span class="n">nx_pydot</span><span class="o">.</span><span class="n">to_pydot</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>

            <span class="c1"># render the `pydot` by calling `dot`, no file saved to disk</span>
            <span class="n">png_str</span> <span class="o">=</span> <span class="n">pydot_graph</span><span class="o">.</span><span class="n">create_png</span><span class="p">(</span><span class="n">prog</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">)</span>

            <span class="c1"># treat the DOT output as an image file</span>
            <span class="n">sio</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">png_str</span><span class="p">)</span>
            <span class="n">sio</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">sio</span><span class="p">)</span>

            <span class="c1"># plot the image</span>
            <span class="n">imgplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Graph.get_topological_order"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.get_topological_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_topological_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#get_sequentil_order</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the topological order of the workflow.</span>

<span class="sd">        :return: list depicting the workflow</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">edge</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">order</span></div>

<div class="viewcode-block" id="Graph.create_topological_order"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Graph.create_topological_order">[docs]</a>    <span class="k">def</span> <span class="nf">create_topological_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#create_sequential_order</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the graph while each node bget a number determined from get_sequential_order.</span>

<span class="sd">        :return: list depicting the workflow</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># or put it in workflow or in both # mey need to be in workflow.</span>

        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_topological_order</span><span class="p">()</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">order</span></div></div>


<div class="viewcode-block" id="Workflow"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow">[docs]</a><span class="k">class</span> <span class="nc">Workflow</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Workflow class that runs all jobs, handles dependencies, etc.</span>

<span class="sd">    ::</span>

<span class="sd">        w = Workflow(filename=&quot;workflow.yaml&quot;)</span>
<span class="sd">        w.load(filename=&quot;abc.yaml&quot;) &lt;- loads in the graph, but will save it still to workflow.yaml</span>
<span class="sd">        w.add(filename=&quot;add.yaml&quot;) &lt;-adds a new workflow into the existing one.</span>
<span class="sd">        w.add_job(name=&quot;a&quot;,</span>
<span class="sd">                    command=&quot;hostname&quot;,</span>
<span class="sd">                    user=None, # bug if kind is local and user is None, we do not need user, but can take local user</span>
<span class="sd">                    host=None, # bug:  if host is none and kind is local use localhost</span>
<span class="sd">                    label=&quot;a&quot;,</span>
<span class="sd">                    kind=&quot;local&quot;,</span>
<span class="sd">                    status=&quot;ready&quot;,</span>
<span class="sd">                    progress=0)</span>
<span class="sd">        w.add_job(name=&quot;b&quot;, command=&quot;ls&quot;)</span>
<span class="sd">        w.add_job(name=&quot;c&quot;, command=&quot;pwd&quot;)</span>
<span class="sd">        w.add_job(name=&quot;d&quot;, command=&quot;uname -a&quot;)</span>
<span class="sd">        w.add_dependencies(dependency=&quot;a,b,d&quot;)</span>
<span class="sd">        w.add_dependencies(dependency=&quot;a,c,d&quot;)</span>

<span class="sd">        w.run()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># original workflow</span>
                 <span class="n">runtime_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># this is where the images are store, as well as the yml file when we run it</span>
                 <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">load</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">clear_runtime_dir</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">runtime</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a workflow with specified characteristics.</span>

<span class="sd">        :param name: name of workflow</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param filename: location of yaml file to load workflow from</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param runtime_dir: directory of yaml file to be read and written to</span>
<span class="sd">        :type runtime_dir: str</span>
<span class="sd">        :param user: name of user</span>
<span class="sd">        :type user: str</span>
<span class="sd">        :param host: location of where the workflow will be run</span>
<span class="sd">        :type host: str</span>
<span class="sd">        :param load: whether to load the workflow</span>
<span class="sd">        :type load: bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># name, label, user, host, status, progress, command</span>
        <span class="c1"># if filename exists, load filename</span>
        <span class="c1"># if graph is not None, overwrite the graph potentially read from filename</span>
        <span class="c1"># gvl reimplemented but did not test</span>
        <span class="c1"># The workflow is run in experiment/workflow</span>

        <span class="c1">#</span>
        <span class="c1"># name may not be defined properly</span>
        <span class="c1">#</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span> <span class="ow">or</span> <span class="s1">&#39;workflow&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;workflow&#39;</span>

        <span class="c1"># self.filename is the filename wherever it is located</span>

        <span class="c1"># self.filename = filename or f&quot;~/.cloudmesh/workflow/{self.name}/{self.name}.yaml&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;workflow&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_dir</span> <span class="o">=</span> <span class="n">runtime_dir</span> <span class="ow">or</span> <span class="n">path_expand</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">/runtime/&quot;</span><span class="p">)</span>

        <span class="c1"># reset the runtime dir if it exists.</span>
        <span class="c1"># if clear_runtime_dir:</span>
        <span class="c1">#     if os.path.isdir(self.runtime_dir):</span>
        <span class="c1">#         Shell.rmdir(self.runtime_dir)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_dir</span><span class="p">):</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_dir</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_dir</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.dat&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">):</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">):</span>
                <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Workflow Filename:&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">load</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># gvl added load but not tested</span>
            <span class="k">if</span> <span class="n">runtime</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">runtime</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>

        <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;created_time&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="s1">&#39;created_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                <span class="s1">&#39;created_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_time</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_topological_order</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">)</span>

        <span class="c1"># should this go into graph?</span>
        <span class="c1"># if Path.exists(filename):</span>
        <span class="c1">#    self.workflow = self.load(filename)</span>
        <span class="c1"># else:</span>
        <span class="c1">#    directory = path_expand(filename)</span>
        <span class="c1">#    Shell.mkdir(directory)</span>
        <span class="c1">#    self.data = {}</span>
        <span class="c1">#    self.save()</span>

        <span class="c1"># self.workflow = {}  # the overall workflow dictionary will have both jobs and dependencies</span>

        <span class="c1"># self.label = None</span>


    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return workflow and its characteristics in string format.</span>

<span class="sd">        :return: string format of workflow</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the jobs of the workflow.</span>

<span class="sd">        :return: the jobs that belong to the workflow</span>
<span class="sd">        :rtype: dotdict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span>  <span class="c1"># [name]</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the details of an item within the workflow.</span>

<span class="sd">        :param name: name of item</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: details of an item within the workflow</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<div class="viewcode-block" id="Workflow.job"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.job">[docs]</a>    <span class="k">def</span> <span class="nf">job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the details of a job within the workflow.</span>

<span class="sd">        :param name: name of job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: details of a job within the workflow</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Retrieve the dependencies of the workflow.</span>

<span class="sd">        :return: the dependencies of the workflow</span>
<span class="sd">        :rtype: dotdict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># gvl implemented but not tested</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span>  <span class="c1"># [name]</span>

<div class="viewcode-block" id="Workflow.predecessor"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.predecessor">[docs]</a>    <span class="k">def</span> <span class="nf">predecessor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the jobs that must be run before the specified job.</span>

<span class="sd">        :param name: name of a job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: list of preceding jobs</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># GVL reimplemented but not tested</span>
        <span class="n">predecessors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span>

        <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">edge</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">predecessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">predecessors</span></div>

<div class="viewcode-block" id="Workflow.get_predecessors"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.get_predecessors">[docs]</a>    <span class="k">def</span> <span class="nf">get_predecessors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the predecessors.</span>

<span class="sd">        Figure out all the dependencies of the name node</span>
<span class="sd">        then test if each node in front (parent) has progress of 100</span>
<span class="sd">        if the parent has progress 100, remove those nodes.</span>

<span class="sd">        :param name: name of a job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: list of preceding jobs</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predecessor</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">candidate</span><span class="p">)[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">parents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parents</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">parents</span></div>

<div class="viewcode-block" id="Workflow.save_with_state"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.save_with_state">[docs]</a>    <span class="k">def</span> <span class="nf">save_with_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the workflow with state.</span>

<span class="sd">        :param filename: which file to save the workflow</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param stdout: if True then return the output</span>
<span class="sd">        :type stdout: bool</span>
<span class="sd">        :return: if stdout is True then returns the string of yaml dump</span>
<span class="sd">        :rtype: None or str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print(self.graph)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;nodes&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">),</span>
            <span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">colors</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;colors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">colors</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">writefile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="Workflow.load_with_state"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.load_with_state">[docs]</a>    <span class="k">def</span> <span class="nf">load_with_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the workflow with state.</span>

<span class="sd">        :param filename: which file to load the workflow from</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;nodes&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;dependencies&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;colors&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">colors</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;colors&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="Workflow.load"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.load">[docs]</a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">clear</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the workflow.</span>

<span class="sd">        Load a workflow graph from file. However, the file is still stored in</span>
<span class="sd">        the filename that was used when the Workflow was created. This allows to</span>
<span class="sd">        load in a saved workflow in another file, but continue working on it in</span>
<span class="sd">        the file used in init.</span>

<span class="sd">        :param filename: which file to load the workflow from</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param clear: whether to clear workflow. not implemented</span>
<span class="sd">        :type clear: bool</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.graph.load(...)</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        workflow:</span>
<span class="sd">          nodes:</span>
<span class="sd">            a:</span>
<span class="sd">               name: a</span>
<span class="sd">               user: gregor</span>
<span class="sd">               host: localhost</span>
<span class="sd">               kind: local</span>
<span class="sd">               status: ready</span>
<span class="sd">               label: job-1-label</span>
<span class="sd">               script: test-a.sh</span>
<span class="sd">            b:</span>
<span class="sd">               name: b</span>
<span class="sd">               user: gregor</span>
<span class="sd">               host: localhost</span>
<span class="sd">               kind: local</span>
<span class="sd">               status: ready</span>
<span class="sd">               label: job-2-label</span>
<span class="sd">               script: test-a.sh</span>
<span class="sd">          dependencies:</span>
<span class="sd">            - a,b</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">()</span>
        <span class="c1"># if not clear:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>

        <span class="c1"># with open(filename, &#39;r&#39;) as stream:</span>
        <span class="c1">#     graph = yaml.safe_load(stream)</span>
        <span class="c1">#</span>
        <span class="c1"># dependencies = graph[&quot;workflow&quot;]</span>
        <span class="c1">#nodes = graph[&quot;workflow&quot;][&quot;nodes&quot;].items()</span>
        <span class="c1">#</span>
        <span class="c1"># # for name, node in graph[&quot;workflow&quot;][&quot;nodes&quot;].items():</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">,</span> <span class="o">**</span><span class="n">node</span><span class="p">)</span></div>
        <span class="c1">#</span>
        <span class="c1"># for edge in dependencies:</span>
        <span class="c1">#     self.add_dependencies(edge)</span>


<div class="viewcode-block" id="Workflow.save"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the workflow.</span>

<span class="sd">        :param filename: where to save the workflow</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if os_is_windows():</span>
        <span class="c1">#     name = os.path.basename(filename).replace(r&quot;.yaml&quot;, &quot;&quot;)</span>
        <span class="c1">#     dir = Shell.map_filename(fr&quot;~/.cloudmesh/workflow/{name}/{name}.yaml&quot;).path</span>
        <span class="c1">#     self.graph.save_to_yaml(dir)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="c1"># do not use runtime dir, use experiment dir</span>
            <span class="c1"># i forgot about exeriment dir</span>
            <span class="c1"># reason experimentdir is noce is that its alos on remote machines</span>

            <span class="c1"># we need to be able to set this</span>

            <span class="c1"># .cloudmesh/workflow/workflow_a/jobs/workflow_a.yaml</span>

            <span class="c1"># cloudmesh:</span>
            <span class="c1">#    workflow:</span>
            <span class="c1">#       localhost:</span>
            <span class="c1">#         name: workflow_a</span>
            <span class="c1">#         source: ~/a.yaml</span>
            <span class="c1">#         runtime_dir: &quot;~/.cloudmesh/workflow/{cloudmesh.workflow.name}/runtime&quot;</span>
            <span class="c1">#         yaml: f&quot;{runtime_dir}/{cloudmesh.workflow.name}.yaml&quot;</span>
            <span class="c1">#       rivanna: ???? eg experiment on remote host must be written somewhere,</span>
            <span class="c1">#                             for now we can yuos use ~</span>
            <span class="c1">#         name: workflow_a</span>
            <span class="c1">#         source: ~/a.yaml</span>
            <span class="c1">#         runtime_dir: &quot;~/.cloudmesh/workflow/{cloudmesh.workflow.name}/runtime&quot;</span>
            <span class="c1">#         yaml: f&quot;{runtime_dir}/{cloudmesh.workflow.name}.yaml&quot;</span>

        <span class="c1"># old</span>
            <span class="c1"># experiment/workflow_a/jobs/workflow_a.yaml</span>
            <span class="c1"># experiment/workflow_a/jobs/workflow_a.yaml</span>
            <span class="c1"># experiment is just like runtime</span>

        <span class="c1"># saveto = f&quot;{self.runtime_dir}/{self.name}.yaml&quot;</span>
            <span class="c1"># saveto = Shell.map_filename(fr&quot;~/.cloudmesh/workflow/{self.name}/runtime/{self.name}.yaml&quot;).path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save_to_yaml</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="c1">#    saveto = filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save_to_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.add_job"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.add_job">[docs]</a>    <span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">label_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;local&quot;</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;ready&quot;</span><span class="p">,</span>
                <span class="n">progress</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">script</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">exec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">pid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">venv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a job to the workflow.</span>

<span class="sd">        :param name: name of job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param user: username for job</span>
<span class="sd">        :type user: str</span>
<span class="sd">        :param host: where the job will be run</span>
<span class="sd">        :type host: str</span>
<span class="sd">        :param label: what the node will say on the graph</span>
<span class="sd">        :type label: str</span>
<span class="sd">        :param label_format: how the label will be formatted in the graph</span>
<span class="sd">        :type label_format:</span>
<span class="sd">        :param kind: the type of job, such as local, ssh, slurm</span>
<span class="sd">        :type kind: str</span>
<span class="sd">        :param status: how the job is doing, like ready, failed, done</span>
<span class="sd">        :type status: str</span>
<span class="sd">        :param progress: a number from 0 to 100 that reports job completeness</span>
<span class="sd">        :type progress: int</span>
<span class="sd">        :param script: the script that the job will run</span>
<span class="sd">        :type script: str</span>
<span class="sd">        :param exec: how the job will be executed</span>
<span class="sd">        :type exec: str</span>
<span class="sd">        :param pid: process id of the job</span>
<span class="sd">        :type pid: int or str</span>
<span class="sd">        :param kwargs: any other miscellaneous specifications for the job</span>
<span class="sd">        :type kwargs: kwargs</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span> <span class="ow">or</span> <span class="n">name</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="ow">or</span> <span class="n">Shell</span><span class="o">.</span><span class="n">user</span><span class="p">()</span>
        <span class="n">host</span> <span class="o">=</span> <span class="n">host</span> <span class="ow">or</span> <span class="n">Shell</span><span class="o">.</span><span class="n">host</span><span class="p">()</span>
        <span class="n">label_format</span> <span class="o">=</span> <span class="n">label_format</span> <span class="ow">or</span> <span class="n">label</span> <span class="ow">or</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">script</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.sh&quot;</span>

        <span class="n">now</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">DateTime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">label_format</span><span class="o">=</span><span class="n">label_format</span><span class="p">,</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
            <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
            <span class="n">created</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">modified</span><span class="o">=</span><span class="n">now</span><span class="p">,</span>
            <span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">,</span>
            <span class="n">exec</span><span class="o">=</span><span class="n">exec</span><span class="p">,</span>
            <span class="n">venv</span><span class="o">=</span><span class="n">venv</span><span class="p">,</span>
            <span class="n">instance</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">)</span>
        <span class="c1"># update the times dat file to show created</span>
        <span class="n">job_created_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
            <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="n">times_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
            <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;created_time_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                    <span class="sa">f</span><span class="s1">&#39;created_time_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_created_time</span>
                <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                <span class="sa">f</span><span class="s1">&#39;created_time_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_created_time</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.add_dependency"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.add_dependency">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a job dependency to the workflow (and the graph).</span>

<span class="sd">        :param source: job to be completed first</span>
<span class="sd">        :type source: str</span>
<span class="sd">        :param destination: job to be completed after the source</span>
<span class="sd">        :type destination: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_dependency</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.add_dependencies"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.add_dependencies">[docs]</a>    <span class="k">def</span> <span class="nf">add_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dependency</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a job dependency to the workflow (and the graph).</span>

<span class="sd">        :param dependency: the dependency to be added</span>
<span class="sd">        :type dependency: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="n">dependency</span><span class="o">=</span><span class="n">dependency</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.update_status"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.update_status">[docs]</a>    <span class="k">def</span> <span class="nf">update_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually update a job&#39;s status.</span>

<span class="sd">        :param name: the job whose status will be updated</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param status: the new status to be set for the job</span>
<span class="sd">        :type status: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span></div>

<div class="viewcode-block" id="Workflow.set_progress"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.set_progress">[docs]</a>    <span class="k">def</span> <span class="nf">set_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">percent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually update a job&#39;s progress.</span>

<span class="sd">        :param name: name of the job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param percent: value from 0 to 100 for the progress</span>
<span class="sd">        :type percent: int</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">percent</span></div>

<div class="viewcode-block" id="Workflow.update_progress"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.update_progress">[docs]</a>    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually update the progress of a job according to its log file.</span>

<span class="sd">        :param name: name of job</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># fetches log file and looks for progress event TBD</span>
        <span class="c1"># once progress is fetched set it for the named job</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="Workflow.run_parallel"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.run_parallel">[docs]</a>    <span class="k">def</span> <span class="nf">run_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;~/experiment&quot;</span><span class="p">,</span>
                     <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">period</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                     <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a workflow in a parallel fashion.</span>

<span class="sd">        :param directory: where the workflow should be run</span>
<span class="sd">        :type directory: str</span>
<span class="sd">        :param order: how the jobs should be run chronologically</span>
<span class="sd">        :type order:</span>
<span class="sd">        :param dryrun: if true then the workflow isn&#39;t really run. for testing</span>
<span class="sd">        :type dryrun: bool</span>
<span class="sd">        :param show: whether to show graph as workflow is run</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param period: how long to wait after showing the graph</span>
<span class="sd">        :type period: float</span>
<span class="sd">        :param filename: where to save the graph</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">undefined</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of completed nodes</span>
        <span class="n">running</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of running nodes</span>
        <span class="n">outstanding</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>  <span class="c1"># list of outstanding nodes</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of failed nodes</span>

        <span class="k">def</span> <span class="nf">info</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Give information about the jobs of the workflow.</span>

<span class="sd">            :return: nothing</span>
<span class="sd">            :rtype: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Undefined:   &quot;</span><span class="p">,</span> <span class="n">undefined</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Completed:   &quot;</span><span class="p">,</span> <span class="n">completed</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running:     &quot;</span><span class="p">,</span> <span class="n">running</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Outstanding: &quot;</span><span class="p">,</span> <span class="n">outstanding</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed:      &quot;</span><span class="p">,</span> <span class="n">failed</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Todo:        &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">todo</span><span class="p">())</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dependencies:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Update the jobs status and progress.</span>

<span class="sd">            :param name: name of job</span>
<span class="sd">            :type name: str</span>
<span class="sd">            :return: nothing</span>
<span class="sd">            :rtype: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">banner</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;update </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
            <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_progress</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress</span>

            <span class="c1"># print(&quot;Job data&quot;, name, status, progress)</span>

            <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">running</span><span class="p">:</span>
                    <span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">completed</span><span class="p">:</span>
                    <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">undefined</span><span class="p">:</span>
                    <span class="n">undefined</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;undefined&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">running</span><span class="p">:</span>
                    <span class="n">running</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">completed</span><span class="p">:</span>
                    <span class="n">completed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">undefined</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">outstanding</span><span class="p">:</span>
                    <span class="n">undefined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="c1"># elif status == &#39;running&#39;:</span>
            <span class="c1">#    ready.remove(name)</span>

        <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Run the job.</span>

<span class="sd">            :param name: name of job</span>
<span class="sd">            :type name: str</span>
<span class="sd">            :return: nothing</span>
<span class="sd">            :rtype: None</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">banner</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">wf_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">experiment_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;~/experiment/</span><span class="si">{</span><span class="n">wf_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">job</span><span class="p">[</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">experiment_directory</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span> <span class="ow">and</span> <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ready&quot;</span><span class="p">]:</span>
                <span class="n">local</span> <span class="o">=</span> <span class="n">wsl</span> <span class="o">=</span> <span class="n">ssh</span> <span class="o">=</span> <span class="n">slurm</span> <span class="o">=</span> <span class="n">lsf</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]:</span>
                    <span class="n">local</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.localhost.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wsl&quot;</span><span class="p">]:</span>
                    <span class="n">wsl</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.wsl.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">]:</span>
                    <span class="n">ssh</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.ssh.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]:</span>
                    <span class="n">slurm</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.slurm.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lsf&#39;</span><span class="p">]:</span>
                    <span class="n">lsf</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.lsf.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.localhost.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">name</span>
                <span class="k">if</span> <span class="n">local</span> <span class="ow">or</span> <span class="n">wsl</span><span class="p">:</span>
                    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                                          <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                                          <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                                          <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                                          <span class="n">directory</span><span class="o">=</span><span class="n">experiment_directory</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ssh</span> <span class="ow">or</span> <span class="n">slurm</span><span class="p">:</span>
                    <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                              <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                              <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                              <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                              <span class="n">directory</span><span class="o">=</span><span class="n">experiment_directory</span><span class="p">)</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
                    <span class="n">job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">local</span> <span class="ow">or</span> <span class="n">wsl</span><span class="p">:</span>
                    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
                    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;instance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
                    <span class="c1"># print(str(job[&quot;instance&quot;]))</span>
                    <span class="n">running</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                    <span class="n">outstanding</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

                <span class="c1"># elif job[&#39;kind&#39;] in [&quot;local-slurm&quot;]:</span>
                <span class="c1">#     raise NotImplementedError</span>
                <span class="c1"># elif job[&#39;kind&#39;] in [&quot;remote-slurm&quot;]:</span>
                <span class="c1">#     raise NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># banner(f&quot;Job: {name}&quot;)</span>
                <span class="n">Console</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os_is_windows</span><span class="p">():</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;./tmp&quot;</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s2">&quot;tmp/workflow.svg&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="s2">&quot;/tmp/workflow.svg&quot;</span>

        <span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>

            <span class="n">info</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">running</span><span class="p">:</span>
                <span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="n">todo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">todo</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">todo</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;TODO&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">start</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># print(self.table)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table2</span><span class="p">(</span><span class="n">with_label</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">os_is_mac</span><span class="p">():</span>
                    <span class="n">Shell</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">first</span> <span class="ow">and</span> <span class="n">os_is_linux</span><span class="p">():</span>
                    <span class="n">Shell</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Shell</span><span class="o">.</span><span class="n">browser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="c1"># if os_is_windows():</span>
                    <span class="c1">#     win = gw.getWindowsWithTitle(&#39;MINGW64:&#39;)</span>
                    <span class="c1">#     win.activate()</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span><span class="p">)</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">completed</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>

            <span class="c1"># debugging</span>
            <span class="c1">#info()</span>
            <span class="c1">#input()</span>

        <span class="c1"># save graph occurs again to make sure things are being saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                        <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
                        <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.run_topo"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.run_topo">[docs]</a>    <span class="k">def</span> <span class="nf">run_topo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">dryrun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the workflow in a topological fashion.</span>

<span class="sd">        :param order: how the jobs should be run chronologically</span>
<span class="sd">        :type order:</span>
<span class="sd">        :param dryrun: if true then the workflow isn&#39;t really run. for testing</span>
<span class="sd">        :type dryrun: bool</span>
<span class="sd">        :param show: whether to show the graph as workflow is run</span>
<span class="sd">        :type show: bool</span>
<span class="sd">        :param filename: where the graph should be saved</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">experiment_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;~/experiment&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">)</span>
        <span class="n">graph_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./runtime/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">save_graph_to_file</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">create_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">graph_file</span><span class="p">,</span>
                            <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
                            <span class="n">layout</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">,</span>
                            <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">display_in_browser</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">graph_file</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">os_is_mac</span><span class="p">():</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">graph_file</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">os_is_linux</span><span class="p">():</span>
                <span class="c1">#  elif first and os_is_linux():</span>
                <span class="c1"># Shell.open(filename=filename)  # does not work</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chromium </span><span class="si">{</span><span class="n">graph_file</span><span class="si">}</span><span class="s2">&amp;&quot;</span><span class="p">)</span>
                <span class="c1"># os.system(f&quot;eog {filename}&quot;)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">browser</span><span class="p">(</span><span class="n">graph_file</span><span class="p">)</span>

        <span class="c1"># bug the tno file needs to be better handled</span>
        <span class="k">if</span> <span class="n">order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="n">path_expand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;runtime/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">order</span><span class="p">()):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">dryrun</span><span class="p">:</span>
                <span class="n">local</span> <span class="o">=</span> <span class="n">wsl</span> <span class="o">=</span> <span class="n">ssh</span> <span class="o">=</span> <span class="n">slurm</span> <span class="o">=</span> <span class="n">lsf</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;local&quot;</span><span class="p">]:</span>
                    <span class="n">local</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.localhost.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;wsl&quot;</span><span class="p">]:</span>
                    <span class="n">wsl</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.wsl.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">]:</span>
                    <span class="n">ssh</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.ssh.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;slurm&#39;</span><span class="p">]:</span>
                    <span class="n">slurm</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.slurm.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">elif</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;lsf&#39;</span><span class="p">]:</span>
                    <span class="n">lsf</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.lsf.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">cloudmesh.cc.job.localhost.Job</span> <span class="kn">import</span> <span class="n">Job</span>
                <span class="k">if</span> <span class="n">local</span> <span class="ow">or</span> <span class="n">ssh</span> <span class="ow">or</span> <span class="n">slurm</span><span class="p">:</span>
                    <span class="n">job</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                <span class="n">label_format</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;label_format&#39;</span><span class="p">]</span>
                <span class="n">host</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
                <span class="n">username</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">name</span>
                <span class="n">venv</span> <span class="o">=</span> <span class="n">job</span><span class="p">[</span><span class="s1">&#39;venv&#39;</span><span class="p">]</span>
                <span class="n">_job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                           <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
                           <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                           <span class="n">label_format</span><span class="o">=</span><span class="n">label_format</span><span class="p">,</span>
                           <span class="n">venv</span><span class="o">=</span><span class="n">venv</span><span class="p">,</span>
                           <span class="n">workflow_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">_job</span><span class="o">.</span><span class="n">sync</span><span class="p">()</span>
                <span class="n">_job</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

                <span class="c1">#add time beginning of workflow if not in times dat file</span>
                <span class="n">workflow_started_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                    <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;t0_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                        <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                            <span class="sa">f</span><span class="s1">&#39;t0_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_started_time</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                        <span class="sa">f</span><span class="s1">&#39;t0_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_started_time</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

                <span class="c1"># update the times dat file if the job just started</span>
                <span class="n">job_started_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                    <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                    <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;tstart_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                        <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                            <span class="sa">f</span><span class="s1">&#39;tstart_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_started_time</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                        <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                        <span class="sa">f</span><span class="s1">&#39;tstart_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_started_time</span>
                    <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

                <span class="n">wait_interval</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># this is to check if status has changed</span>
                <span class="n">placeholder_progress</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">placeholder_status</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">while</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">_job</span><span class="o">.</span><span class="n">get_status</span><span class="p">()</span>
                    <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_job</span><span class="o">.</span><span class="n">get_progress</span><span class="p">(</span><span class="n">refresh</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Progress </span><span class="si">{</span><span class="n">_job</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="n">progress</span><span class="p">)</span>
                    <span class="n">log</span> <span class="o">=</span> <span class="n">_job</span><span class="o">.</span><span class="n">get_log</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">log</span><span class="p">)</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="n">progress</span> <span class="o">==</span> <span class="mi">100</span>
                    <span class="k">if</span> <span class="n">progress</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">progress</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">):</span>
                        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">progress</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save_to_yaml</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime_filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">!=</span> <span class="n">placeholder_progress</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">placeholder_status</span><span class="p">):</span>
                        <span class="c1"># update the times dat file to show modified</span>
                        <span class="n">job_modified_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                            <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                            <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                        <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
                        <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
                            <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                                <span class="sa">f</span><span class="s1">&#39;modified_time_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_modified_time</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                                <span class="sa">f</span><span class="s1">&#39;modified_time_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_modified_time</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

                        <span class="c1"># show end time if job just ended</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="o">==</span> <span class="mi">100</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">):</span>
                            <span class="n">job_end_time</span> <span class="o">=</span> <span class="n">workflow_end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                                <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%Y, %H:%M:%S&quot;</span><span class="p">)</span>
                            <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                                <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                            <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">times_dict</span> <span class="o">=</span> <span class="p">{}</span>
                            <span class="k">if</span> <span class="s1">&#39;times&#39;</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">:</span>
                                <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;tend_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                                    <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                                        <span class="sa">f</span><span class="s1">&#39;tend_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_end_time</span>

                                <span class="c1"># if this is the last job and it just finished</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="sa">f</span><span class="s1">&#39;t1_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">times_dict</span><span class="p">[</span>
                                            <span class="s1">&#39;times&#39;</span><span class="p">]:</span>
                                        <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span>
                                            <span class="sa">f</span><span class="s1">&#39;t1_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_end_time</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                                    <span class="sa">f</span><span class="s1">&#39;tend_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">job_end_time</span>
                                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="p">())</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">times_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="p">{})[</span>
                                        <span class="sa">f</span><span class="s1">&#39;t1_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow_end_time</span>
                            <span class="n">d</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">times_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
                            <span class="n">writefile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">times_filename</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

                        <span class="n">save_graph_to_file</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
                            <span class="n">display_in_browser</span><span class="p">()</span>
                        <span class="n">placeholder_status</span> <span class="o">=</span> <span class="n">status</span>
                        <span class="n">placeholder_progress</span> <span class="o">=</span> <span class="n">progress</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">finished</span><span class="p">:</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait_interval</span><span class="p">)</span>



                <span class="c1"># if local or wsl or slurm:</span>
                <span class="c1">#     _job.watch(period=0.5)</span>
                <span class="c1"># elif ssh or slurm:</span>
                <span class="c1">#     _job.watch(period=3)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">done</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
                <span class="c1">#print(self.table)</span>
                <span class="c1">#_job.watch(period=1)</span>


                <span class="c1">#print(&#39;Status: &#39;, status)</span>
                <span class="c1">#print(&#39;Progress: &#39;, progress)</span>
                 <span class="c1"># elif job[&#39;kind&#39;] in [&quot;local-slurm&quot;]:</span>
                <span class="c1">#     raise NotImplementedError</span>
                <span class="c1"># elif job[&#39;kind&#39;] in [&quot;remote-slurm&quot;]:</span>
                <span class="c1">#     raise NotImplementedError</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># banner(f&quot;Job: {name}&quot;)</span>
                <span class="n">Console</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;running </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.display"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;workflow&#39;</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Show the graph of the workflow.</span>

<span class="sd">        :param filename: location of the graph</span>
<span class="sd">        :type filename: str</span>
<span class="sd">        :param name: name of the workflow to be displayed</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param first: if True then this is first time graph is displayed</span>
<span class="sd">        :type first: bool</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;./</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.svg&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os_is_mac</span><span class="p">():</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os_is_linux</span><span class="p">():</span>
            <span class="c1">#  elif first and os_is_linux():</span>
            <span class="c1"># Shell.open(filename=filename)  # does not work</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;chromium </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&amp;&quot;</span><span class="p">)</span>
            <span class="c1"># os.system(f&quot;eog {filename}&quot;)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">browser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.create_topological_order"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.create_topological_order">[docs]</a>    <span class="k">def</span> <span class="nf">create_topological_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#create_sequential_order</span>
        <span class="c1"># or put it in workflow or in both # mey need to be in workflow.</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the graph while each node bget a number determined from get_sequential_order.</span>

<span class="sd">        :return: list depicting the workflow</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># tuples = []</span>
        <span class="c1"># for name, edge in self.graph.edges.items():</span>
        <span class="c1">#     tuples.append((edge[&quot;source&quot;], edge[&quot;destination&quot;]))</span>
        <span class="c1"># g = nx.DiGraph(tuples)</span>
        <span class="c1"># order = list(nx.topological_sort(g))</span>
        <span class="c1"># return order</span>

        <span class="c1"># detrmon the order based on nodes and edges using toposort</span>
        <span class="c1"># itterate through the order (nwmaes, ids), and set the no to thedopological soort</span>
        <span class="c1"># for i in self.get_sequential_order():</span>
        <span class="c1">#     node[top[i]][&quot;number&quot;] = i</span>
        <span class="c1"># pass</span>

        <span class="n">numbers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">job_to_be_indexed</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">():</span>
            <span class="n">numbers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                <span class="n">job_to_be_indexed</span><span class="p">))</span>

        <span class="n">jobs_and_id</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sequential_order</span><span class="p">(),</span> <span class="n">numbers</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">job_name</span><span class="p">,</span> <span class="n">primary_key</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                                         <span class="n">jobs_and_id</span><span class="p">):</span>
            <span class="n">current_job</span> <span class="o">=</span> <span class="n">primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">current_job</span><span class="p">][</span><span class="s1">&#39;number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">primary_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="Workflow.sequential_order"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.sequential_order">[docs]</a>    <span class="k">def</span> <span class="nf">sequential_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="c1">#get_sequentil_order</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of the topological order of the workflow.</span>

<span class="sd">        :return: list depicting the workflow</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tuples</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">edge</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">],</span> <span class="n">edge</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">order</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">yaml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a yaml dump of the nodes and dependencies of the workflow.</span>

<span class="sd">        :return: yaml dump of workflow as string</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">),</span>
            <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dict_of_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dict of the nodes and dependencies of the workflow.</span>

<span class="sd">        :return: dict of workflow</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">),</span>
            <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">data</span>

<div class="viewcode-block" id="Workflow.json"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.json">[docs]</a>    <span class="k">def</span> <span class="nf">json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the workflow as json string.</span>

<span class="sd">        :param filepath: where the file is located</span>
<span class="sd">        :type filepath: str</span>
<span class="sd">        :return: a json string of the workflow</span>
<span class="sd">        :rtype: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">),</span>
            <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a table of the workflow.</span>

<span class="sd">        :return: a table of the workflow</span>
<span class="sd">        :rtype: None or PrettyTable or str or dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># gvl rewritten</span>
        <span class="n">with_label</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">create_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">with_label</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;label&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;label_format&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Printer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                             <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.table2"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.table2">[docs]</a>    <span class="k">def</span> <span class="nf">table2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">with_label</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a table of the workflow.</span>

<span class="sd">        :param with_label: whether to include label in table</span>
<span class="sd">        :type with_label: bool</span>
<span class="sd">        :return: a table of the workflow</span>
<span class="sd">        :rtype: None or PrettyTable or str or dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># gvl rewritten</span>
        <span class="c1"># with_label = False</span>

        <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">create_label</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">with_label</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;label&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Printer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                             <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.remove_workflow"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.remove_workflow">[docs]</a>    <span class="k">def</span> <span class="nf">remove_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete workflow from the local file system.</span>

<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># gvl rewritten</span>
        <span class="c1"># TODO: the rm seems wrong</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -r </span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Workflow.remove_job"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.remove_job">[docs]</a>    <span class="k">def</span> <span class="nf">remove_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a particular job from the workflow.</span>

<span class="sd">        :param name: name of job to be removed from workflow</span>
<span class="sd">        :type name: str</span>
<span class="sd">        :param state: whether to save workflow with state after job removal</span>
<span class="sd">        :type state: bool</span>
<span class="sd">        :return: nothing</span>
<span class="sd">        :rtype: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># del self.jobs[name]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># print(&quot;popped:&quot;,p)</span>

        <span class="c1"># remove dependencies to job</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

        <span class="n">dellist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">dependency</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dependency</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">dependency</span><span class="p">[</span><span class="s2">&quot;destination&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                <span class="n">dellist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge</span><span class="p">)</span>

        <span class="c1"># TODO: remove parent node</span>
        <span class="c1"># if self.graph.nodes[name][&quot;parent&quot;]:</span>
        <span class="c1">#     dellist.append(self.graph.nodes[name][&quot;parent&quot;])</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">dellist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_with_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="Workflow.status"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return details of the workflow in dict format.</span>

<span class="sd">        :return: details of workflow in dict format</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># gvl implemented but not tested</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;done&quot;</span>
        <span class="n">_status</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;workflow&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">,</span>
                   <span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">]</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;progress&quot;</span><span class="p">]</span>
            <span class="n">_status</span><span class="p">[</span><span class="s2">&quot;jobs&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
                <span class="s2">&quot;progress&quot;</span><span class="p">:</span> <span class="n">progress</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;undefined&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;undefined&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;failed&quot;</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ready&quot;</span><span class="p">]:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;ready&quot;</span>
        <span class="n">_status</span><span class="p">[</span><span class="s2">&quot;workflow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
        <span class="k">return</span> <span class="n">_status</span></div>

<div class="viewcode-block" id="Workflow.analyze_states"><a class="viewcode-back" href="../../../cloudmesh.cc.html#cloudmesh.cc.workflow.Workflow.analyze_states">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_states</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a wordcount on status.</span>

<span class="sd">        :return: dict of occurrences of each status</span>
<span class="sd">        :rtype: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>

        <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
            <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Gregor von Laszewski and Jacques Fleischer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>