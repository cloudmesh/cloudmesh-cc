<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cloudmesh.cc.service.service &mdash; cloudmesh-cc 4.3.7 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/readthedocs-custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> cloudmesh-cc
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction.html">What Is Cloudmesh cc?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../abstract.html">Extended Abstract</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../manual/cc.html">Command cc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rest.html">REST</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rest-gui.html">REST GUI Web Browser Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../python.html">Python Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../specifying-workflows.html">Specifying Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../service.html">Service</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="openapi3.html#http://">OpenAPI</a></li>
<li class="toctree-l1"><a class="reference external" href="openapi.json#http://">OpenAPI (json)</a></li>
<li class="toctree-l1"><a class="reference external" href="openapi.yaml#http://">OpenAPI (yaml)</a></li>
<li class="toctree-l1"><a class="reference external" href="py-modindex.html#http://">Python API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../mnist.html">MNIST Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../cloudmask.html">Cloudmask Workflow</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Contributors Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../todos.html">Todo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../acknowledgements.html">Acknowledgments</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cloudmesh-cc</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>cloudmesh.cc.service.service</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cloudmesh.cc.service.service</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Cloudmesh cc FastAPI service for REST and web interfaces.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">posixpath</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>

<span class="kn">import</span> <span class="nn">httpx</span>
<span class="kn">import</span> <span class="nn">markdown</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">UploadFile</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Form</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">FileResponse</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">RedirectResponse</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span> <span class="nn">fastapi.responses</span> <span class="kn">import</span> <span class="n">StreamingResponse</span>
<span class="kn">from</span> <span class="nn">fastapi.staticfiles</span> <span class="kn">import</span> <span class="n">StaticFiles</span>
<span class="kn">from</span> <span class="nn">fastapi.templating</span> <span class="kn">import</span> <span class="n">Jinja2Templates</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">sse_starlette.sse</span> <span class="kn">import</span> <span class="n">EventSourceResponse</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span> <span class="nn">cloudmesh.cc.__version__</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">cm_version</span>
<span class="kn">from</span> <span class="nn">cloudmesh.cc.workflow</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.Printer</span> <span class="kn">import</span> <span class="n">Printer</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.Shell</span> <span class="kn">import</span> <span class="n">Shell</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.console</span> <span class="kn">import</span> <span class="n">Console</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">path_expand</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.util</span> <span class="kn">import</span> <span class="n">writefile</span><span class="p">,</span> <span class="n">readfile</span>
<span class="kn">from</span> <span class="nn">cloudmesh.common.variables</span> <span class="kn">import</span> <span class="n">Variables</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">all the URLs.</span>
<span class="sd">@app.get(&quot;/&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">@app.get(&quot;/workflows&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">    ?json</span>
<span class="sd">    ?yaml</span>
<span class="sd">    ?html</span>
<span class="sd">    ?dict</span>
<span class="sd">    </span>
<span class="sd">@app.post(&quot;/workflow/upload&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">@app.delete(&quot;/workflow/{workflow_name}&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">@app.get(&quot;/workflow/{workflow_name}&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">@app.get(&quot;/workflow/run/{workflow_name}&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">@app.post(&quot;/workflow/{workflow_name}&quot;, tags=[&#39;workflow&#39;])</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">variables</span> <span class="o">=</span> <span class="n">Variables</span><span class="p">()</span>

<span class="c1"># debug = variables[&#39;debug&#39;]</span>
<span class="c1"># debug = False</span>
<span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1">#</span>
<span class="c1"># set if portal routes should be displayed in the documentation</span>
<span class="c1">#</span>
<span class="c1"># include_portal_tag_in_schema = debug</span>
<span class="n">include_portal_tag_in_schema</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="get_available_workflows"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.get_available_workflows">[docs]</a><span class="k">def</span> <span class="nf">get_available_workflows</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return workflow dirs found in .cloudmesh directory.</span>

<span class="sd">    :return: names of workflows found</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/&quot;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/*&quot;</span><span class="p">)</span>

    <span class="c1"># result = [os.path.basename(e) for e in result]</span>

    <span class="k">def</span> <span class="nf">check_if_workflow_has_yaml</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">True</span>

    <span class="k">for</span> <span class="n">possible_folder</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">check_if_workflow_has_yaml</span><span class="p">(</span><span class="n">possible_folder</span><span class="p">):</span>
            <span class="n">folders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">possible_folder</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">folders</span></div>


<div class="viewcode-block" id="dict_of_available_workflows"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.dict_of_available_workflows">[docs]</a><span class="k">def</span> <span class="nf">dict_of_available_workflows</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Return a dict of available workflows.</span>

<span class="sd">    looks inside ~/.cloudmesh/workflow directory</span>
<span class="sd">    for available workflows and returns them</span>
<span class="sd">    as initialized workflows inside a dict</span>
<span class="sd">    :return: available workflows as dict</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">list_of_workflows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">dict_of_workflow_dicts</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="n">list_of_workflows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">workflow</span> <span class="ow">in</span> <span class="n">list_of_workflows</span><span class="p">:</span>
        <span class="n">dict_of_workflow_dicts</span><span class="p">[</span><span class="n">workflow</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">dict_of_workflow</span>
    <span class="k">return</span> <span class="n">dict_of_workflow_dicts</span></div>


<div class="viewcode-block" id="Jobpy"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.Jobpy">[docs]</a><span class="k">class</span> <span class="nc">Jobpy</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A python job.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">progress</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span></div>


<span class="c1"># q = test_run()</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;cloudmesh-cc&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">cm_version</span><span class="p">)</span>

<span class="c1">#</span>
<span class="c1"># REGISTER template and static dir</span>
<span class="c1">#</span>

<span class="n">static_dir</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;cloudmesh.cc&quot;</span><span class="p">,</span> <span class="s2">&quot;service/static&quot;</span><span class="p">)</span>

<span class="n">app</span><span class="o">.</span><span class="n">mount</span><span class="p">(</span><span class="s2">&quot;/static&quot;</span><span class="p">,</span> <span class="n">StaticFiles</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">static_dir</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">)</span>

<span class="n">template_dir</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;cloudmesh.cc&quot;</span><span class="p">,</span> <span class="s2">&quot;service/templates&quot;</span><span class="p">)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">template_dir</span><span class="p">)</span>

<span class="n">www_dir</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;cloudmesh.cc&quot;</span><span class="p">,</span> <span class="s2">&quot;www&quot;</span><span class="p">)</span>
<span class="n">www</span> <span class="o">=</span> <span class="n">Jinja2Templates</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">www_dir</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># ROUTES</span>
<span class="c1">#</span>


<div class="viewcode-block" id="load_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.load_workflow">[docs]</a><span class="k">def</span> <span class="nf">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Workflow</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Load a workflow corresponding to given name.</span>

<span class="sd">    :param name: name of workflow</span>
<span class="sd">    :type name: str</span>
<span class="sd">    :param load:</span>
<span class="sd">    :type load:</span>
<span class="sd">    :return: loaded workflow</span>
<span class="sd">    :rtype: Workflow</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> <span class="n">load</span><span class="o">=</span><span class="n">load</span><span class="p">)</span>
    <span class="c1"># w.__init__(filename=filename)</span>
    <span class="c1"># w.load(filename=filename)</span>
    <span class="c1"># w.load(filename)</span>
    <span class="c1"># print(w.yaml)</span>
    <span class="k">return</span> <span class="n">w</span></div>


<div class="viewcode-block" id="image_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.image_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">image_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Watch an svg for changes.</span>

<span class="sd">    :param name_of_workflow: name of workflow to get svg for</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: svg as text form</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="c1"># w = load_workflow(name=name_of_workflow, load=False)</span>
    <span class="c1"># w.graph.load(filename=filename)</span>
    <span class="n">svg_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="c1"># w.graph.save(filename=svg_file, colors=&quot;status&quot;,</span>
    <span class="c1">#              layout=nx.circular_layout, engine=&quot;dot&quot;)</span>

    <span class="n">runtime_graph_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.svg&#39;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runtime_graph_file</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">svg_file</span><span class="p">,</span> <span class="n">runtime_graph_file</span><span class="p">)</span>

    <span class="n">placeholder_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">svg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">current_timestamp</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">runtime_graph_file</span><span class="p">)</span><span class="o">.</span><span class="n">st_mtime</span>
        <span class="k">if</span> <span class="n">current_timestamp</span> <span class="o">!=</span> <span class="n">placeholder_timestamp</span><span class="p">:</span>
            <span class="n">placeholder_timestamp</span> <span class="o">=</span> <span class="n">current_timestamp</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">svg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">Shell</span><span class="o">.</span><span class="n">find_lines_between</span><span class="p">(</span><span class="n">readfile</span><span class="p">(</span><span class="n">runtime_graph_file</span><span class="p">)</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(),</span>
                                             <span class="sa">r</span><span class="s1">&#39;&lt;svg&#39;</span><span class="p">,</span>
                                             <span class="sa">r</span><span class="s1">&#39;&lt;/svg&gt;&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                <span class="k">pass</span>
            <span class="k">yield</span> <span class="n">svg</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="penultimate_status_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.penultimate_status_watcher">[docs]</a><span class="k">def</span> <span class="nf">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Watch a runtime yaml for status changes.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve statuses for</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: dictionary/Counter of statuses</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="n">runtime_yaml</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">original_yaml</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runtime_yaml</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_yaml</span><span class="p">,</span> <span class="n">runtime_yaml</span><span class="p">)</span>

    <span class="n">runtime_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">runtime_yaml</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">runtime_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">runtime_dict</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>  <span class="c1"># ?</span>
        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runtime_dict</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
        <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="datatable_server"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.datatable_server">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">datatable_server</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that returns datatable when changes are detected.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve datatable for</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: the datatable as html</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.2</span>
    <span class="n">runtime_yaml_filepath</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
    <span class="n">original_yaml_filepath</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>

    <span class="c1"># w = load_workflow(name_of_workflow)</span>
    <span class="c1"># w.create_topological_order()</span>

    <span class="k">def</span> <span class="nf">runtime_dict_getter</span><span class="p">():</span>

        <span class="n">runtime_yaml_to_read</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">runtime_yaml_filepath</span><span class="p">)</span>
        <span class="n">runtime_yaml_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">runtime_yaml_to_read</span><span class="p">)</span>

        <span class="n">original_yaml_to_read</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">original_yaml_filepath</span><span class="p">)</span>
        <span class="n">original_yaml_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">original_yaml_to_read</span><span class="p">)</span>

        <span class="n">times_filename</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.dat&#39;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="n">times_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">times_filename</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">times_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">times_dict_for_table</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1"># we must delete the job names that are merely expanded dependencies</span>
        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="c1"># print(node_name)</span>
            <span class="c1"># print(w.graph.nodes.keys())</span>
            <span class="k">if</span> <span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
                <span class="k">del</span> <span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
            <span class="c1"># else:</span>
            <span class="c1">#    runtime_yaml_file[&#39;workflow&#39;][&#39;nodes&#39;][job_name][&#39;no&#39;] = dict_with_order[&#39;nodes&#39;][job_name][&#39;no&#39;]</span>
        <span class="c1"># banner(str(w.graph.nodes[job_name][&#39;progress&#39;]))</span>
        <span class="c1"># pprint.pprint(w.graph.nodes)</span>

        <span class="c1"># add timers</span>
        <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">for</span> <span class="n">timer</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tstart_</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;tend_</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">times_dict_for_table</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span> <span class="o">=</span> <span class="n">times_dict</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">][</span><span class="n">timer</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">times_dict_for_table</span><span class="p">[</span><span class="n">timer</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;N/A&#39;</span>

        <span class="n">dictionary</span> <span class="o">=</span> <span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span>
        <span class="n">table_html_template</span> <span class="o">=</span> \
            <span class="sa">fr</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;table id=&quot;example&quot; class=&quot;display&quot; style=&quot;width:100%&quot;&gt;</span>
<span class="s2">                &lt;thead&gt;</span>
<span class="s2">                    &lt;tr&gt;</span>
<span class="s2">                        &lt;th&gt;ID&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Name&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Status&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Host&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Progress&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Start&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;End&lt;/th&gt;</span>
<span class="s2">                        &lt;th&gt;Script&lt;/th&gt;</span>
<span class="s2">                    &lt;/tr&gt;</span>
<span class="s2">                &lt;/thead&gt;</span>
<span class="s2">                &lt;tbody&gt;</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">job</span><span class="p">,</span> <span class="n">items</span> <span class="ow">in</span> <span class="n">dictionary</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">table_html_template</span> <span class="o">+=</span> \
                <span class="sa">fr</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                    &lt;tr&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&amp;nbsp;&lt;progress value=&quot;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;progress&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot; max=&quot;100&quot;&gt;&lt;/progress&gt;&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">times_dict_for_table</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tstart_</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">times_dict_for_table</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;tend_</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                        &lt;td&gt;</span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="s1">&#39;script&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;/td&gt;</span>
<span class="s2">                    &lt;/tr&gt;</span>
<span class="s2">                &quot;&quot;&quot;</span>
        <span class="n">table_html_template</span> <span class="o">+=</span> \
            <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                &lt;/tbody&gt;</span>
<span class="sd">                &lt;tfoot&gt;</span>
<span class="sd">                    &lt;tr&gt;</span>
<span class="sd">                    &lt;/tr&gt;</span>
<span class="sd">                &lt;/tfoot&gt;</span>
<span class="sd">            &lt;/table&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">table_html_template</span>

    <span class="n">placeholder_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">current_workflow_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">readfile</span><span class="p">(</span><span class="n">runtime_yaml_filepath</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">current_workflow_dict</span> <span class="o">!=</span> <span class="n">placeholder_dict</span><span class="p">:</span>
            <span class="n">placeholder_dict</span> <span class="o">=</span> <span class="n">current_workflow_dict</span>
            <span class="n">html_to_return</span> <span class="o">=</span> <span class="n">runtime_dict_getter</span><span class="p">()</span>
            <span class="k">yield</span> <span class="n">html_to_return</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="done_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.done_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">done_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that yields number of jobs that are done.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve done count</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: number of jobs done</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                           <span class="n">name_of_workflow</span><span class="o">=</span><span class="n">name_of_workflow</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_done_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">]</span>
            <span class="n">status_dict</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">current_done_count</span> <span class="o">!=</span> <span class="n">placeholder_status_count</span><span class="p">:</span>
                <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="n">current_done_count</span>
                <span class="k">yield</span> <span class="n">current_done_count</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="ready_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.ready_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">ready_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that yields number of jobs that are ready.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve ready count</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: number of jobs ready</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                           <span class="n">name_of_workflow</span><span class="o">=</span><span class="n">name_of_workflow</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_ready_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">]</span>
            <span class="n">status_dict</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">current_ready_count</span> <span class="o">!=</span> <span class="n">placeholder_status_count</span><span class="p">:</span>
                <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="n">current_ready_count</span>
                <span class="k">yield</span> <span class="n">current_ready_count</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="failed_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.failed_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">failed_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that yields number of jobs that are failed.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve failed count</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: number of jobs failed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                           <span class="n">name_of_workflow</span><span class="o">=</span><span class="n">name_of_workflow</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_failed_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span>
            <span class="n">status_dict</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">current_failed_count</span> <span class="o">!=</span> <span class="n">placeholder_status_count</span><span class="p">:</span>
                <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="n">current_failed_count</span>
                <span class="k">yield</span> <span class="n">current_failed_count</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="submitted_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.submitted_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">submitted_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that yields number of jobs that are submitted.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve submitted count</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: number of jobs submitted</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                           <span class="n">name_of_workflow</span><span class="o">=</span><span class="n">name_of_workflow</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_submitted_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;submitted&#39;</span><span class="p">]</span>
            <span class="n">status_dict</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">current_submitted_count</span> <span class="o">!=</span> <span class="n">placeholder_status_count</span><span class="p">:</span>
                <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="n">current_submitted_count</span>
                <span class="k">yield</span> <span class="n">current_submitted_count</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="running_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.running_watcher">[docs]</a><span class="k">async</span> <span class="k">def</span> <span class="nf">running_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Server side event watcher that yields number of jobs that are running.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param name_of_workflow: name of workflow to retrieve running count</span>
<span class="sd">    :type name_of_workflow: str</span>
<span class="sd">    :return: number of jobs running</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">interval</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">penultimate_status_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                           <span class="n">name_of_workflow</span><span class="o">=</span><span class="n">name_of_workflow</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">is_disconnected</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_running_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="s1">&#39;running&#39;</span><span class="p">]</span>
            <span class="n">status_dict</span> <span class="o">=</span> <span class="n">count</span>
            <span class="k">if</span> <span class="n">current_running_count</span> <span class="o">!=</span> <span class="n">placeholder_status_count</span><span class="p">:</span>
                <span class="n">placeholder_status_count</span> <span class="o">=</span> <span class="n">current_running_count</span>
                <span class="k">yield</span> <span class="n">current_running_count</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="status_returner"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.status_returner">[docs]</a><span class="k">def</span> <span class="nf">status_returner</span><span class="p">(</span><span class="n">name_of_workflow</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a runtime yaml file to return a dict of status of jobs.</span>

<span class="sd">    :param name_of_workflow:</span>
<span class="sd">    :type name_of_workflow:</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">runtime_yaml</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">original_yaml</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">name_of_workflow</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runtime_yaml</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_yaml</span><span class="p">,</span> <span class="n">runtime_yaml</span><span class="p">)</span>
    <span class="n">runtime_dict</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">runtime_yaml</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>

    <span class="n">states</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">runtime_dict</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>  <span class="c1"># ?</span>
        <span class="n">states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">runtime_dict</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">])</span>

    <span class="n">count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;done&#39;</span><span class="p">,</span> <span class="s1">&#39;ready&#39;</span><span class="p">,</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;submitted&#39;</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">]:</span>
        <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span></div>


<div class="viewcode-block" id="serve_done"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_done">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/done-count/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_done</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the number of done jobs.</span>

<span class="sd">    **request** (Request) that is supplied when using web interface</span>
<span class="sd">    **workflow_name** (str) name of workflow</span>
<span class="sd">    **return** (EventSourceResponse) event source response for server side event</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: event source response for server side event</span>
<span class="sd">    :rtype: EventSourceResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">done_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="serve_ready"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_ready">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/ready-count/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_ready</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the number of ready jobs.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: event source response for server side event</span>
<span class="sd">    :rtype: EventSourceResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">ready_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="serve_failed"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_failed">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/failed-count/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_failed</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the number of failed jobs.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: event source response for server side event</span>
<span class="sd">    :rtype: EventSourceResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">failed_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="serve_submitted"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_submitted">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/submitted-count/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_submitted</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the number of submitted jobs.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: event source response for server side event</span>
<span class="sd">    :rtype: EventSourceResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">submitted_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="serve_running"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_running">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/running-count/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_running</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Give the number of running jobs.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: event source response for server side event</span>
<span class="sd">    :rtype: EventSourceResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">running_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<span class="c1">#</span>
<span class="c1"># HOME</span>
<span class="c1">#</span>

<div class="viewcode-block" id="home_page"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.home_page">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/home&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">home_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the home page.</span>

<span class="sd">    home function that features html and</span>
<span class="sd">    sidebar</span>

<span class="sd">    :return: up message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="s2">&quot;cloudmesh/cc/service/markdown/home.md&quot;</span>
    <span class="n">contact</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;home.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                                    <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                                    <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">})</span></div>


<span class="c1">#</span>
<span class="c1"># CONTACT</span>
<span class="c1">#</span>

<div class="viewcode-block" id="contact_page"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.contact_page">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/contact&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">contact_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page that lists contact information.</span>

<span class="sd">    :return: contact page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
    <span class="n">page</span> <span class="o">=</span> <span class="s2">&quot;cloudmesh/cc/service/markdown/contact.md&quot;</span>
    <span class="n">contact</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">contact</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;contact.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                       <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">})</span></div>


<div class="viewcode-block" id="man_page"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.man_page">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/manpage&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">man_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page that shows manual of cms cc command.</span>

<span class="sd">    :return: contact page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;cms help cc | grep -v &quot;# Timer&quot; | grep -v &quot;patch enabled so applying the patch&quot; | grep -v &quot;Alpha Channel fix&quot;&#39;</span><span class="p">)</span>

    <span class="n">page</span> <span class="o">=</span> <span class="s2">&quot;cloudmesh/cc/service/markdown/manpage.md&quot;</span>

    <span class="n">manpage</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">manpage</span> <span class="o">+=</span> <span class="s1">&#39;```bash</span><span class="se">\n</span><span class="s1">&#39;</span>
    <span class="n">manpage</span> <span class="o">+=</span> <span class="n">r</span>
    <span class="n">manpage</span> <span class="o">+=</span> <span class="s1">&#39;```&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">manpage</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">manpage</span><span class="p">,</span> <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fenced_code&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;manpage.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                       <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">})</span></div>


<div class="viewcode-block" id="about_page"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.about_page">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/about&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">about_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page that lists readme as html.</span>

<span class="sd">    :return: about page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="n">page</span> <span class="o">=</span> <span class="s2">&quot;cloudmesh/cc/service/markdown/about.md&quot;</span>
    <span class="n">about</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">markdown</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">about</span><span class="p">)</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;about.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="n">html</span><span class="p">,</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">})</span></div>

<div class="viewcode-block" id="add_page"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.add_page">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/add&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page that allows users to add workflows.</span>

<span class="sd">    :return: add page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;add.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">})</span></div>

<div class="viewcode-block" id="add_post"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.add_post">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/add&#39;</span><span class="p">,</span>
          <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">,</span>
          <span class="n">response_class</span><span class="o">=</span><span class="n">RedirectResponse</span><span class="p">,</span>
          <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">add_post</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                   <span class="n">dirname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                   <span class="n">archivename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">UploadFile</span><span class="p">]</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                   <span class="n">yaml</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add workflow from html page.</span>

<span class="sd">    :param workflow_name: the name of the new workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :param dirname: path to dir with workflow files</span>
<span class="sd">    :type dirname: str</span>
<span class="sd">    :param archivename: path to archive file with workflow files</span>
<span class="sd">    :type archivename: str</span>
<span class="sd">    :param yaml: path to workflow yaml file</span>
<span class="sd">    :type yaml: str</span>
<span class="sd">    :return: redirect to home page</span>
<span class="sd">    :rtype: RedirectResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dirname</span><span class="p">:</span>
        <span class="n">archivename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># # with file upload</span>
        <span class="c1"># async with httpx.AsyncClient(timeout=httpx.Timeout(100.0)) as client:</span>
        <span class="c1">#     r = await client.post(</span>
        <span class="c1">#</span>
        <span class="c1">#     )</span>
        <span class="n">upload_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span>
                        <span class="n">directory</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span>
                        <span class="n">yaml</span><span class="o">=</span><span class="n">yaml</span><span class="p">,</span>
                        <span class="n">archive</span><span class="o">=</span><span class="n">archivename</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">archivename</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">contents</span> <span class="o">=</span> <span class="n">archivename</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">archivename</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">archivename</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}{</span><span class="n">archivename</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}{</span><span class="n">archivename</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">upload_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">,</span>
                        <span class="n">directory</span><span class="o">=</span><span class="n">dirname</span><span class="p">,</span>
                        <span class="n">yaml</span><span class="o">=</span><span class="n">yaml</span><span class="p">,</span>
                        <span class="n">archive</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}{</span><span class="n">archivename</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">rm</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}{</span><span class="n">archivename</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">#upload_workflow(archivename=archivename.filename)</span>
    <span class="c1">#</span>
    <span class="c1"># else:</span>
    <span class="c1">#     r = upload_workflow(directory=dirname,</span>
    <span class="c1">#                 archive=archivename,</span>
    <span class="c1">#                 yaml=yaml,</span>
    <span class="c1">#                 workflow_name=workflow_name)</span>
    <span class="c1"># print(r)</span>
    <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="s1">&#39;/home&#39;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span></div>
    <span class="c1"># folders = get_available_workflows()</span>
    <span class="c1"># print(preferences)</span>


<span class="c1">#</span>
<span class="c1"># WORKFLOW</span>
<span class="c1">#</span>


<div class="viewcode-block" id="list_workflows"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.list_workflows">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflows&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">list_workflows</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a list of all workflows found on local computer.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **output**: (str) format to print available workflows, which can be</span>
<span class="sd">    json, csv, or none which prints it as dict</span>

<span class="sd">    :param output: format to print available workflows, which can be</span>
<span class="sd">    json, csv, or none which prints it as dict</span>
<span class="sd">    :type output: str</span>
<span class="sd">    :return: list of workflow names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># &quot;&quot;&quot;</span>
    <span class="c1"># curl -X &#39;GET&#39; \</span>
    <span class="c1">#     &#39;http://127.0.0.1:8000/workflows&#39; \</span>
    <span class="c1">#     -H &#39;accept: application/json&#39;</span>
    <span class="c1"># &quot;&quot;&quot;</span>
    <span class="n">dict_of_workflow_dicts</span> <span class="o">=</span> <span class="n">dict_of_available_workflows</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">json_workflow</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dict_of_workflow_dicts</span><span class="p">)</span>
            <span class="n">json_filepath</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/all-workflows-json.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">writefile</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">,</span> <span class="n">json_workflow</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dict_of_workflow_dicts</span><span class="p">)</span>
            <span class="n">csv_filepath</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/all-workflows-csv.csv&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>

            <span class="c1"># stream = io.StringIO()</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()),</span>
                                         <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attachment; filename=all-workflows-csv.csv&quot;</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;workflows&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;No workflows found&quot;</span><span class="p">}</span></div>


<span class="c1"># we need to be putting in there whatever we need to be updating.</span>
<span class="c1"># 1. upload a.yaml (standalone, doesnt need anything else)</span>
<span class="c1"># 1.1 upload a.yaml?name=d</span>
<span class="c1"># 2. upload b.yaml (contains b.sh, b.ipynb, b.py, and maybe b.data)</span>
<span class="c1"># 2.1 upload b.yaml?name=d</span>
<span class="c1"># 2.1 this needs a second part - upload b.sh, b.ipynb, b.py, b.data</span>
<span class="c1"># 3. upload directory/* (the * represents the yaml and the scripts)</span>
<span class="c1"># 3.1 the name is determined from the yaml file in that directory</span>
<span class="c1"># 3.2 upload directory?name=d</span>
<span class="c1"># the uploaded workflow is called &#39;d&#39; (placeholder name)</span>
<span class="c1"># 4. upload compressed file (tar) the format is tgz,xz (two different formats)</span>
<span class="c1"># 4.1 a.tgz and a.xz which contain whatever is being provided in 1,2,3</span>
<span class="c1"># 4.2 they are uncompressed just as if they were to do an individual upload.</span>
<span class="c1"># name is optional because the name is determined on what is provided</span>
<div class="viewcode-block" id="upload_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.upload_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/workflow&quot;</span><span class="p">,</span> <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/workflow/upload&quot;</span><span class="p">,</span> <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">upload_workflow</span><span class="p">(</span><span class="n">directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">description</span><span class="o">=</span><span class="s1">&#39;path to workflow dir &#39;</span>
                                              <span class="s1">&#39;that contains scripts &#39;</span>
                                              <span class="s1">&#39;and yaml file&#39;</span><span class="p">),</span>
                    <span class="n">archive</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;path to archive file that &#39;</span>
                                            <span class="s1">&#39;can be tgx, xz, tar.gz, &#39;</span>
                                            <span class="s1">&#39;or tar&#39;</span><span class="p">),</span>
                    <span class="n">yaml</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;path to yaml file for workflow&#39;</span><span class="p">),</span>
                    <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">description</span><span class="o">=</span><span class="s1">&#39;name of workflow to be uploaded&#39;</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Upload a workflow.</span>

<span class="sd">    Upload a workflow to the ~/.cloudmesh/workflow directory for running</span>
<span class="sd">    or editing.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **directory**: (str) path to directory with workflow files</span>
<span class="sd">    - **archive**: (str) path to archive file, which can be tgx, xz, tar.gz,</span>
<span class="sd">    or tar, that contains workflow files</span>
<span class="sd">    - **yaml**: (str) path to yaml file that specifies workflow configuration</span>
<span class="sd">    - **workflow_name**: (str) name of workflow to be uploaded</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param directory: path to directory with workflow files</span>
<span class="sd">    :type directory: str</span>

<span class="sd">    curl -X &#39;POST&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/upload?directory=~/cm/cloudmesh-cc/tests/workflow-example&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39; \</span>
<span class="sd">        -d &#39;&#39;</span>

<span class="sd">    :param archive: tgz, xz, tar.gz, or tar file with workflow files</span>
<span class="sd">    :type archive: str</span>

<span class="sd">    curl -X &#39;POST&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/upload?archive=ThePathToYourArchiveFile&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39; \</span>
<span class="sd">        -d &#39;&#39;</span>

<span class="sd">    :param yaml: yaml file with workflow specifications</span>
<span class="sd">    :type yaml: str</span>

<span class="sd">    curl -X &#39;POST&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/upload?yaml=~/cm/cloudmesh-cc/tests/workflow-example/workflow-example.yaml&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39; \</span>
<span class="sd">        -d &#39;&#39;</span>

<span class="sd">    :return: success or failure message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="n">directory</span><span class="p">,</span> <span class="n">archive</span><span class="p">,</span> <span class="n">yaml</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only one upload option can be chosen.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Only one upload option can be chosen.&quot;</span><span class="p">}</span>

    <span class="k">elif</span> <span class="n">directory</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">expanded_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">):</span>
                <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s2"> is not a valid dir path&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s2"> is not a valid dir path&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_name</span><span class="p">:</span>
                <span class="n">workflow_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">)</span>
            <span class="c1"># try:</span>
            <span class="c1">#     Shell.run(f&#39;tar -C {expanded_dir_path} -cf {name}.tar .&#39;)</span>
            <span class="c1"># except Exception as e:</span>
            <span class="c1">#     print(e.output)</span>
            <span class="c1"># tar_location = Path(</span>
            <span class="c1">#     Shell.map_filename(f&#39;./{name}.tar&#39;).path).as_posix()</span>
            <span class="c1">#</span>
            <span class="n">runtime_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/runtime/&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">yaml_location</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">)</span>
            <span class="c1"># command = f&#39;tar --strip-components 1 --force-local -xvf {tar_location} -C {runtime_directory}&#39;</span>
            <span class="c1">#</span>
            <span class="c1"># print(command)</span>
            <span class="c1"># os.system(command)</span>
            <span class="c1"># Shell.rm(f&#39;{tar_location}&#39;)</span>
            <span class="n">expanded_dir_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># expanded_dir_path = Path(expanded_dir_path).as_posix()</span>

            <span class="c1"># these try excepts are needed in the case of a workflow with</span>
            <span class="c1"># all py files, or all sh files, or all ipynb files</span>
            <span class="k">for</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;yaml&quot;</span><span class="p">,</span> <span class="s2">&quot;sh&quot;</span><span class="p">,</span> <span class="s2">&quot;py&quot;</span><span class="p">,</span> <span class="s2">&quot;ipynb&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;yaml&#39;</span><span class="p">:</span>
                        <span class="n">Shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cp </span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s1">*.</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">runtime_directory</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;cp </span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s1">*.</span><span class="si">{</span><span class="n">kind</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">runtime_directory</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>  <span class="c1"># noqa: E722</span>
                    <span class="k">pass</span>
            <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">,</span>
                                                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
            <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">,</span> <span class="n">yaml_location</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">yaml</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully uploaded </span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2"> dir&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error uploading the file </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

    <span class="k">elif</span> <span class="n">archive</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_name</span><span class="p">:</span>
                <span class="n">workflow_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">archive</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">runtime_directory</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/runtime/&quot;</span><span class="p">)</span>
            <span class="n">yaml_location</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
            <span class="n">runtime_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">archive_location</span> <span class="o">=</span> <span class="n">archive</span>

            <span class="k">if</span> <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tgz&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xz&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar.gz&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar&#39;</span><span class="p">):</span>

                <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>
                <span class="c1"># Shell.mkdir(runtime_directory)</span>
                <span class="k">if</span> <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.tar&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">archive</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.xz&#39;</span><span class="p">):</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tar --strip-components 1 --force-local -xvf </span><span class="si">{</span><span class="n">archive_location</span><span class="si">}</span><span class="s1"> -C </span><span class="si">{</span><span class="n">runtime_directory</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;tar --strip-components 1 --force-local -xvzf </span><span class="si">{</span><span class="n">archive_location</span><span class="si">}</span><span class="s1"> -C </span><span class="si">{</span><span class="n">runtime_directory</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">,</span>
                                                     <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
                <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">,</span> <span class="n">yaml_location</span><span class="p">)</span>
                <span class="n">w</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">yaml</span><span class="p">)</span>

                <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully uploaded </span><span class="si">{</span><span class="n">archive</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error uploading the file </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="c1"># finally:</span>
        <span class="c1">#     await file.close()</span>

    <span class="k">elif</span> <span class="n">yaml</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">yaml</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow_name</span><span class="p">:</span>
                <span class="n">workflow_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">original_yaml_location</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="n">yaml</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">yaml_location</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">runtime_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_expand</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/runtime/&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LOG: Create Workflow at:&quot;</span><span class="p">,</span> <span class="n">yaml_location</span><span class="p">)</span>
            <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">original_yaml_location</span><span class="p">,</span> <span class="n">yaml_location</span><span class="p">)</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">yaml</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Successfully uploaded </span><span class="si">{</span><span class="n">yaml</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error uploading the file </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span></div>


<span class="c1"># import requests</span>
<span class="c1">#</span>
<span class="c1"># url = &#39;http://127.0.0.1:8000/workflow/upload&#39;</span>
<span class="c1"># file = {&#39;file&#39;: open(&#39;images/1.png&#39;, &#39;rb&#39;)}</span>
<span class="c1"># resp = requests.post(url=url, files=file)</span>
<span class="c1"># print(resp.json())</span>

<div class="viewcode-block" id="delete_workflow_direct_url"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.delete_workflow_direct_url">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/delete/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">delete_workflow_direct_url</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a workflow by url.</span>

<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>

<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># w = load_workflow(workflow_name)</span>
        <span class="n">directory</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/home&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error deleting the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="reset_workflow_direct_url"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.reset_workflow_direct_url">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/reset/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reset_workflow_direct_url</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                              <span class="n">redirect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reset a workflow by url.</span>

<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>

<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># w = load_workflow(workflow_name)</span>
        <span class="n">workflow_runtime_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="n">workflow_runtime_star</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="n">workflow_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">workflow_runtime_dir</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workflow_runtime_star</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">)</span> <span class="ow">or</span> \
                        <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.svg&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.dat&quot;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">files2</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workflow_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files2</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
                    <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">workflow_runtime_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">redirect</span> <span class="o">==</span> <span class="s1">&#39;graph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/watcher/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">?output=table&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error resetting the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="delete_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.delete_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">job</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Delete a workflow by name.</span>

<span class="sd">    deletes an entire workflow. if the job is specified, then deletes</span>
<span class="sd">    just the job in the workflow.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **workflow_name**: (str) name of workflow to delete</span>
<span class="sd">    - **job**: (str) name of job to delete in a workflow, if specified</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    example curl:</span>
<span class="sd">    we need to have first uploaded workflow-example for this curl to work!</span>
<span class="sd">    curl -X &#39;DELETE&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/workflow-example&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39;</span>

<span class="sd">    :param workflow_name: name of the workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :param job: name of the job</span>
<span class="sd">    :type job: str</span>
<span class="sd">    :return: success or failure message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">job</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># if we specify to delete the job</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="c1"># print(w[job])</span>
            <span class="n">w</span><span class="o">.</span><span class="n">remove_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;The job </span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2"> was deleted in the workflow </span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error deleting the job &#39;</span><span class="si">{</span><span class="n">job</span><span class="si">}</span><span class="s2">&#39; in workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># if we specify to delete the workflow</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># w = load_workflow(workflow_name)</span>
            <span class="n">directory</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -rf </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;The workflow </span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2"> was deleted and the directory </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2"> was removed&quot;</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error deleting the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="edit_workflow_direct_url"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.edit_workflow_direct_url">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/edit/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">],</span>
         <span class="n">status_code</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
         <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">edit_workflow_direct_url</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Edit a workflow by url.</span>

<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: failure message if it fails</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># w = load_workflow(workflow_name)</span>
        <span class="n">yaml_file</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
        <span class="c1"># os.system(f&quot;emacs {yaml_file}&quot;)</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">edit</span><span class="p">(</span><span class="n">yaml_file</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error editing the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span></div>

<div class="viewcode-block" id="preferences_changer"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.preferences_changer">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/preferences-changer&quot;</span><span class="p">,</span>
         <span class="n">status_code</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
         <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">preferences_changer</span><span class="p">(</span><span class="n">column</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change a preference to show a column from within datatable viewer.</span>

<span class="sd">    :param column:</span>
<span class="sd">    :type column:</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">loaded_preferences</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">loaded_preferences</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>
        <span class="n">loaded_preferences</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">loaded_preferences</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">loaded_preferences</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.get_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_workflow</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                 <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">initialized</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the workflow.</span>

<span class="sd">    retrieves a workflow by its name. if the job is specified, retrieves</span>
<span class="sd">    just the job in the specified workflow</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **workflow_name**: (str) name of workflow to retrieve</span>
<span class="sd">    - **output**: (str) how to print workflow, which can be</span>
<span class="sd">    html, graph, json, table, or csv. if not specified, then returned as dict</span>
<span class="sd">    - **initialized**: (bool) indicates whether workflow has already been</span>
<span class="sd">    loaded for the first time. should be True when switching views</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    you need to have first uploaded the workflow-example for this curl to work!</span>
<span class="sd">    curl -X &#39;GET&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/workflow-example&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39;</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of the workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :param output: how to print workflow. can be html or table</span>
<span class="sd">    :type output: str</span>
<span class="sd">    :return: success or failure message</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
            <span class="c1"># #result = [os.path.basename(e) for e in result]</span>
            <span class="c1"># w = load_workflow(name=workflow_name)</span>
            <span class="c1"># print(w.dict_of_workflow)</span>
            <span class="c1"># df = pd.DataFrame(w.dict_of_workflow)</span>
            <span class="c1"># df_html = df.to_html()</span>
            <span class="c1"># #html_workflow = Printer.write(table=w_dict, output=&#39;html&#39;)</span>
            <span class="c1"># script_dir = os.path.dirname(os.path.realpath(__file__))</span>
            <span class="c1"># script_dir = os.path.join(script_dir, &#39;templates&#39;)</span>
            <span class="c1"># script_dir = os.path.join(script_dir, f&#39;{workflow_name}-html.html&#39;)</span>
            <span class="c1"># writefile(script_dir, df_html)</span>
            <span class="c1"># return templates.TemplateResponse(f&quot;{workflow_name}-html.html&quot;, {&quot;request&quot;: request})</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="n">test</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">table</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>
            <span class="n">workflow_html</span> <span class="o">=</span> <span class="n">Printer</span><span class="o">.</span><span class="n">dict_html</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">)</span>
            <span class="n">script_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">-html.html&#39;</span><span class="p">)</span>
            <span class="n">writefile</span><span class="p">(</span><span class="n">script_dir</span><span class="p">,</span> <span class="n">workflow_html</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">-html.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">})</span>

        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;graph&#39;</span><span class="p">:</span>
            <span class="n">runtime_svg</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runtime_svg</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">runtime_svg</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">svg_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svg_file</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
                         <span class="n">layout</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">svg_file</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="n">w_dict</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">dict_of_workflow</span>
            <span class="n">json_workflow</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">w_dict</span><span class="p">)</span>
            <span class="n">json_filepath</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">-json.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">writefile</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">,</span> <span class="n">json_workflow</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
            <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
            <span class="c1"># we must initialize preferences in case they do not exist</span>
            <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">):</span>
                <span class="n">table_preferences</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">table_preferences</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">initialized</span><span class="p">:</span>
                <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>

            <span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;status&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;name&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;progress&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;script&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;user&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;parent&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;kind&#39;</span><span class="p">]</span>

            <span class="c1"># workflow_dict = Printer.dict(w.graph.nodes, order=order)</span>

            <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
                <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                           <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">):</span>
                <span class="c1"># check if the preferences file is outdated</span>
                <span class="n">loaded_preferences</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
                    <span class="n">Path</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
                <span class="k">if</span> <span class="n">preferences</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">!=</span> <span class="n">loaded_preferences</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># delete the old preferences file and force</span>
                    <span class="c1"># the user to use the GUI to make a new one</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">preferences</span> <span class="o">=</span> <span class="n">loaded_preferences</span>


            <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;workflow-table.html&quot;</span><span class="p">,</span>
                                              <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                               <span class="s2">&quot;name_of_workflow&quot;</span><span class="p">:</span> <span class="n">workflow_name</span><span class="p">,</span>
                                               <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                               <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">preferences</span><span class="p">})</span>

        <span class="k">elif</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;csv&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="n">w_dict</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">dict_of_workflow</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">w_dict</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()),</span>
                                         <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">)</span>

            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;Content-Disposition&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;attachment; filename=</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">-csv.csv&quot;</span>
            <span class="k">return</span> <span class="n">response</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error with getting the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">workflow_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_available_workflows</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">workflow_name</span><span class="p">:</span> <span class="n">w</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error with getting the workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_job"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.get_job">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">/job/</span><span class="si">{job_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">output</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
            <span class="n">job_dict</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">job</span><span class="p">(</span><span class="n">job_name</span><span class="p">)</span>
            <span class="n">json_workflow</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">job_dict</span><span class="p">)</span>
            <span class="n">json_filepath</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s1">-json.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
            <span class="n">writefile</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">,</span> <span class="n">json_workflow</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">FileResponse</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">traceflag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;There was an error with getting the job &#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&#39; from workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">}</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">w</span><span class="p">[</span><span class="n">job_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span>
                            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Job &#39;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&#39; not in workflow &#39;</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">job_name</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span></div>


<div class="viewcode-block" id="get_workflow_graph"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.get_workflow_graph">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflow-graph/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_workflow_graph</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;See the graph embedded within web interface.</span>

<span class="sd">    :param request: request that is supplied when using web interface</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow to retrieve the graph for</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: html page with graph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># folders = get_available_workflows()</span>
    <span class="c1"># svg = f&quot;http://127.0.0.1:8000/workflow/{workflow_name}?output=graph&quot;</span>
    <span class="c1"># import requests</span>
    <span class="c1"># r = requests.get(svg)</span>
    <span class="c1"># # r = &#39;&#39;&#39;</span>
    <span class="c1"># # &lt;ul&gt;</span>
    <span class="c1"># #     &lt;li&gt;</span>
    <span class="c1"># #         hello</span>
    <span class="c1"># #     &lt;/li&gt;</span>
    <span class="c1"># # &lt;/ul&gt;</span>
    <span class="c1"># # &#39;&#39;&#39;</span>
    <span class="c1">#</span>
    <span class="c1"># print(r.text)</span>
    <span class="c1"># w = load_workflow(workflow_name)</span>
    <span class="c1"># status_dict = w.analyze_states()</span>
    <span class="c1"># return templates.TemplateResponse(&quot;workflow-graph.html&quot;,</span>
    <span class="c1">#                                   {&quot;request&quot;: request,</span>
    <span class="c1">#                                    &quot;svg&quot;: r.text,</span>
    <span class="c1">#                                    &quot;name_of_workflow&quot;: name,</span>
    <span class="c1">#                                    &quot;workflowlist&quot;: folders,</span>
    <span class="c1">#                                    &quot;status_dict&quot;: status_dict})</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">image_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="serve_watcher"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_watcher">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/watcher/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_watcher</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    :param request:</span>
<span class="sd">    :type request:</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>

    <span class="n">runtime_svg</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">runtime_svg</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">svg_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.svg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
        <span class="n">w</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">svg_file</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">,</span>
                     <span class="n">layout</span><span class="o">=</span><span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>

    <span class="c1"># w = load_workflow(workflow_name)</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;watcher.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">workflow_name</span><span class="p">,</span>
                                       <span class="s2">&quot;name_of_workflow&quot;</span><span class="p">:</span> <span class="n">workflow_name</span><span class="p">,</span>  <span class="c1"># same as name</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">})</span></div>


<div class="viewcode-block" id="serve_table"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.serve_table">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/serve-datatable/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_table</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;See the table of the workflow.</span>

<span class="sd">    :param request:</span>
<span class="sd">    :type request:</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">event_generator</span> <span class="o">=</span> <span class="n">datatable_server</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">EventSourceResponse</span><span class="p">(</span><span class="n">event_generator</span><span class="p">)</span></div>


<div class="viewcode-block" id="run_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.run_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflow/run/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">run_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">run_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;topo&quot;</span><span class="p">,</span>
                 <span class="n">redirect</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a specified workflow according to provided run type.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **workflow_name**: (str) name of workflow to run</span>
<span class="sd">    - **run_type**: (str) how to run workflow. only topo is implemented</span>
<span class="sd">    (topological sort of jobs)</span>
<span class="sd">    - **redirect**: (str) where to redirect after initializing the run.</span>
<span class="sd">    only graph is implemented for web interface. None will disable redirect</span>
<span class="sd">    - **show**: (bool) whether to show the graph as the workflow is run</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    example curl:</span>
<span class="sd">    we need to have first uploaded workflow-example for this curl to work!</span>
<span class="sd">    curl -X &#39;GET&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/run/workflow-example?run_type=topo&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39;</span>

<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :param run_type: type of run, either topo or parallel</span>
<span class="sd">    :type run_type: str</span>
<span class="sd">    :param redirect: where to redirect after initiating run</span>
<span class="sd">    :type redirect: str</span>
<span class="sd">    :param show: whether to display the graph as the workflow runs</span>
<span class="sd">    :type show: bool</span>
<span class="sd">    :return: success or exception message</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># reset the yaml and the log files</span>
    <span class="n">workflow_runtime_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">workflow_runtime_star</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">workflow_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">workflow_runtime_dir</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workflow_runtime_star</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.log&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">files2</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">workflow_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.yaml&quot;</span><span class="p">):</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">workflow_runtime_dir</span><span class="p">)</span>

    <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">workflow_name</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">create_topological_order</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">run_type</span> <span class="o">==</span> <span class="s2">&quot;topo&quot;</span><span class="p">:</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">run_topo</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="n">show</span><span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c1"># w.run_topo(show=True)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">run_parallel</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;show&#39;</span><span class="p">:</span> <span class="n">show</span><span class="p">})</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="c1"># w.run_parallel(show=True)</span>
        <span class="c1"># return {&quot;Success&quot;: &quot;Workflow ran successfully&quot;}</span>
        <span class="k">if</span> <span class="n">redirect</span> <span class="o">==</span> <span class="s1">&#39;graph&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/watcher/</span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/workflow-running/</span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="watch_running_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.watch_running_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/workflow-running/</span><span class="si">{workflow_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;portal&#39;</span><span class="p">],</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">watch_running_workflow</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
                           <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Page for watching a workflow that has been started.</span>

<span class="sd">    :param request: type of request (api does this automatically in browser)</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param workflow_name: name of workflow</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: html page with updating table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>

    <span class="n">runtime_yaml_filepath</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/runtime/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
    <span class="n">original_yaml_filepath</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">workflow_name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>

    <span class="n">runtime_yaml_to_read</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">runtime_yaml_filepath</span><span class="p">)</span>
    <span class="n">original_yaml_to_read</span> <span class="o">=</span> <span class="n">readfile</span><span class="p">(</span><span class="n">original_yaml_filepath</span><span class="p">)</span>

    <span class="n">runtime_yaml_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">runtime_yaml_to_read</span><span class="p">)</span>
    <span class="n">original_yaml_file</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">original_yaml_to_read</span><span class="p">)</span>

    <span class="c1"># we must delete the job names that are merely expanded dependencies</span>
    <span class="k">for</span> <span class="n">job_name</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c1"># print(node_name)</span>
        <span class="c1"># print(w.graph.nodes.keys())</span>
        <span class="k">if</span> <span class="n">job_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">original_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">][</span><span class="n">job_name</span><span class="p">]</span>
        <span class="c1"># else:</span>
        <span class="c1">#    runtime_yaml_file[&#39;workflow&#39;][&#39;nodes&#39;][job_name][&#39;no&#39;] = dict_with_order[&#39;nodes&#39;][job_name][&#39;no&#39;]</span>
    <span class="c1"># banner(str(w.graph.nodes[job_name][&#39;progress&#39;]))</span>
    <span class="c1"># pprint.pprint(w.graph.nodes)</span>

    <span class="c1"># pprint(runtime_yaml_file[&#39;workflow&#39;][&#39;nodes&#39;])</span>

    <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">):</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;workflow-running.html&quot;</span><span class="p">,</span>
                                      <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                       <span class="s2">&quot;dictionary&quot;</span><span class="p">:</span> <span class="n">runtime_yaml_file</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">][</span><span class="s1">&#39;nodes&#39;</span><span class="p">],</span>
                                       <span class="s2">&quot;name_of_workflow&quot;</span><span class="p">:</span> <span class="n">workflow_name</span><span class="p">,</span>
                                       <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                       <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">preferences</span><span class="p">})</span></div>


<div class="viewcode-block" id="add_job"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.add_job">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">/job/</span><span class="si">{job_name}</span><span class="s2">&quot;</span><span class="p">,</span>
         <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">user</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">script</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">exec</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">progress</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">parent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds a job to a workflow.</span>

<span class="sd">    A check</span>
<span class="sd">    is returned and the user is alerted if arguments are missing</span>
<span class="sd">    arguments are passed in ATTRIBUTE=VALUE fashion.</span>
<span class="sd">    if the name of the workflow is omitted, the default workflow is used.</span>
<span class="sd">    If no job name is specified, an automated number that is kept in the</span>
<span class="sd">    config.yaml file will be used and the name will be job-n</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **job_name**: (str) the name of job to add</span>
<span class="sd">    - **workflow_name**: (str) the name of the workflow to add the job to</span>
<span class="sd">    - **user**: (str) name of user of the job</span>
<span class="sd">    - **host**: (str) name of the host of the job</span>
<span class="sd">    - **kind**: (str) the kind of job, like ssh, slurm, local,</span>
<span class="sd">    - **status**: (str) the status of the job, such as ready,</span>
<span class="sd">    - **script**: (str) the name of the script to be run,</span>
<span class="sd">    including file extension</span>
<span class="sd">    - **exec**: (str) command(s) to execute</span>
<span class="sd">    - **progress**: (str) value of job progress from 0 to 100</span>
<span class="sd">    - **label**: (str) text to be shown on node in the graph</span>
<span class="sd">    - **parent**: (str) parent job</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Example curl Script**</span>

<span class="sd">    We need to have first uploaded workflow-example for this curl to work:</span>

<span class="sd">    curl -X &#39;POST&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/workflow-example/job/myJob?user=aPerson&amp;host=local&amp;kind=local&amp;status=ready&amp;script=aJob.sh&amp;progress=0&amp;label=aLabel&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39;</span>
<span class="sd">    </span>
<span class="sd">    :param job_name: the name of the job to add</span>
<span class="sd">    :type job_name: str</span>
<span class="sd">    :param workflow_name: the name of the workflow to add the job to</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :param user: name of user of the job</span>
<span class="sd">    :type user: str</span>
<span class="sd">    :param host: name of the host of the job</span>
<span class="sd">    :type host: str</span>
<span class="sd">    :param kind: the kind of job, like ssh, slurm, local</span>
<span class="sd">    :type kind: str</span>
<span class="sd">    :param status: the status of the job, such as ready</span>
<span class="sd">    :type status: str</span>
<span class="sd">    :param script: the name of the script to be run, including file extension</span>
<span class="sd">    :type script: str</span>
<span class="sd">    :param exec: command(s) to execute</span>
<span class="sd">    :type exec: str</span>
<span class="sd">    :param progress: value of job progress from 0 to 100</span>
<span class="sd">    :type progress: str</span>
<span class="sd">    :param label: text to be shown on node in the graph</span>
<span class="sd">    :type label: str</span>
<span class="sd">    :param parent: parent job</span>
<span class="sd">    :type parent: str</span>
<span class="sd">    :return: returns jobs within the specified workflow</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cms cc workflow service add [--name=NAME] --job=JOB ARGS...</span>
    <span class="c1"># cms cc workflow service add --name=workflow --job=c user=gregor host=localhost kind=local status=ready script=c.sh</span>
    <span class="c1"># curl -X &#39;POST&#39; &#39;http://127.0.0.1:8000/workflow/workflow/job/c?user=gregor&amp;host=localhost&amp;kind=local&amp;status=ready&amp;script=c.sh&#39; -H &#39;accept: application/json&#39;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span>
                  <span class="n">name</span><span class="o">=</span><span class="n">job_name</span><span class="p">,</span>
                  <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                  <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
                  <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                  <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                  <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                  <span class="n">progress</span><span class="o">=</span><span class="n">progress</span><span class="p">,</span>
                  <span class="n">script</span><span class="o">=</span><span class="n">script</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parent</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">add_dependencies</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">save_with_state</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;jobs&quot;</span><span class="p">:</span> <span class="n">w</span><span class="o">.</span><span class="n">jobs</span><span class="p">}</span></div>


<div class="viewcode-block" id="remove_job"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.remove_job">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;/workflow/</span><span class="si">{workflow_name}</span><span class="s2">/job/</span><span class="si">{job_name}</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;workflow&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">remove_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
               <span class="n">workflow_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes a job from a workflow.</span>

<span class="sd">    Parameters:</span>

<span class="sd">    - **job_name**: (str) the name of job to add</span>
<span class="sd">    - **workflow_name**: (str) the name of the workflow to add the job to</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    **Example curl Script**</span>

<span class="sd">    We need to have first uploaded workflow-example for this curl to work:</span>

<span class="sd">    curl -X &#39;DELETE&#39; \</span>
<span class="sd">        &#39;http://127.0.0.1:8000/workflow/workflow-example/job/analyze&#39; \</span>
<span class="sd">        -H &#39;accept: application/json&#39;</span>

<span class="sd">    :param job_name: the name of the job to add</span>
<span class="sd">    :type job_name: str</span>
<span class="sd">    :param workflow_name: the name of the workflow to add the job to</span>
<span class="sd">    :type workflow_name: str</span>
<span class="sd">    :return: returns jobs within the specified workflow</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># cms cc workflow service add [--name=NAME] --job=JOB ARGS...</span>
    <span class="c1"># cms cc workflow service add --name=workflow --job=c user=gregor host=localhost kind=local status=ready script=c.sh</span>
    <span class="c1"># curl -X &#39;POST&#39; &#39;http://127.0.0.1:8000/workflow/workflow/job/c?user=gregor&amp;host=localhost&amp;kind=local&amp;status=ready&amp;script=c.sh&#39; -H &#39;accept: application/json&#39;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">load_workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">workflow_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">w</span><span class="o">.</span><span class="n">remove_job</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception:&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">w</span><span class="o">.</span><span class="n">jobs</span><span class="p">}</span></div>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/preferences&#39;</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">preferences_post</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Preferences page.</span>

<span class="sd">    :param request:</span>
<span class="sd">    :type request:</span>

<span class="sd">    :return: preferences page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">get_available_workflows</span><span class="p">()</span>
    <span class="c1"># read this from configuration file</span>
    <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">preferences</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                   <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">):</span>
        <span class="n">preferences</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">)</span><span class="o">.</span><span class="n">read_text</span><span class="p">())</span>
    <span class="c1"># for key, value in preferences.items():</span>
    <span class="c1"># if value:</span>
    <span class="c1"># value = &#39;checked&#39;</span>
    <span class="c1"># page = &quot;cloudmesh/cc/service/markdown/contact.md&quot;</span>
    <span class="c1"># import markdown</span>
    <span class="c1"># contact = readfile(page)</span>
    <span class="c1"># html = markdown.markdown(contact)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="s2">&quot;preferences.html&quot;</span><span class="p">,</span>
                                   <span class="p">{</span><span class="s2">&quot;request&quot;</span><span class="p">:</span> <span class="n">request</span><span class="p">,</span>
                                    <span class="s2">&quot;workflowlist&quot;</span><span class="p">:</span> <span class="n">folders</span><span class="p">,</span>
                                    <span class="s2">&quot;preferences&quot;</span><span class="p">:</span> <span class="n">preferences</span><span class="p">})</span>
    <span class="n">pprint</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">r</span>


<div class="viewcode-block" id="preferences_post"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.preferences_post">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;/preferences&#39;</span><span class="p">,</span>
          <span class="n">status_code</span><span class="o">=</span><span class="mi">204</span><span class="p">,</span>
          <span class="n">response_class</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span>
          <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">preferences_post</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">name</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">host</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">progress</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">start</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">end</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                     <span class="n">script</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Form</span><span class="p">(</span><span class="kc">False</span><span class="p">)):</span>
    <span class="sd">&quot;&quot;&quot;Set preferences.</span>

<span class="sd">    :param id: show the id of a job</span>
<span class="sd">    :type id: bool</span>
<span class="sd">    :param name: show the name of the job</span>
<span class="sd">    :type name: bool</span>
<span class="sd">    :param status: show the status of a job</span>
<span class="sd">    :type status: bool</span>
<span class="sd">    :param host: show the host of a job</span>
<span class="sd">    :type host: bool</span>
<span class="sd">    :param progress: show the progress of a job</span>
<span class="sd">    :type progress: bool</span>
<span class="sd">    :param script: show the script of a job</span>
<span class="sd">    :type script: bool</span>
<span class="sd">    :param start: show the start time of a job</span>
<span class="sd">    :type start: bool</span>
<span class="sd">    :param end: show the end time of a job</span>
<span class="sd">    :type end: bool</span>
<span class="sd">    :return:</span>
<span class="sd">    :rtype:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># folders = get_available_workflows()</span>
    <span class="c1"># print(preferences)</span>
    <span class="n">table_preferences</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="nb">id</span><span class="p">,</span>
        <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
        <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
        <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
        <span class="s1">&#39;progress&#39;</span><span class="p">:</span> <span class="n">progress</span><span class="p">,</span>
        <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="n">start</span><span class="p">,</span>
        <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="n">end</span><span class="p">,</span>
        <span class="s1">&#39;script&#39;</span><span class="p">:</span> <span class="n">script</span>
    <span class="p">}</span>
    <span class="n">dot_cloudmesh_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="s1">&#39;~/.cloudmesh/workflow&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="n">configuration_file</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="s1">&#39;~/.cloudmesh/workflow/table-preferences.yaml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">dot_cloudmesh_dir</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dot_cloudmesh_dir</span><span class="p">)</span>
    <span class="c1"># if not os.path.isfile(configuration_file):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">configuration_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">table_preferences</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="generate_example_workflow"><a class="viewcode-back" href="../../../../cloudmesh.cc.service.html#cloudmesh.cc.service.service.generate_example_workflow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/generate-example&#39;</span><span class="p">,</span>
         <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">,</span>
         <span class="n">response_class</span><span class="o">=</span><span class="n">RedirectResponse</span><span class="p">,</span>
         <span class="n">include_in_schema</span><span class="o">=</span><span class="n">include_portal_tag_in_schema</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">generate_example_workflow</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create example workflow for testing.</span>

<span class="sd">    :return: failure message or a redirection to homepage upon success</span>
<span class="sd">    :rtype: dict or RedirectResponse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">workflow_example_dir</span> <span class="o">=</span> <span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span>
        <span class="s1">&#39;~/.cloudmesh/workflow/workflow-example&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">path</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">workflow_example_dir</span><span class="p">):</span>
        <span class="n">Shell</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">workflow_example_dir</span><span class="p">)</span>
    <span class="n">service_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="vm">__file__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="n">service_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">service_file</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="n">cc_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">service_dir</span><span class="p">))))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="n">test_example_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cc_dir</span><span class="si">}</span><span class="s1">/tests/workflow-example/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="n">expanded_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">Shell</span><span class="o">.</span><span class="n">map_filename</span><span class="p">(</span><span class="n">test_example_dir</span><span class="p">)</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">):</span>
        <span class="n">Console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s2"> is not a valid dir path&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expanded_dir_path</span><span class="si">}</span><span class="s2"> is not a valid dir path&quot;</span><span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">)</span>
    <span class="c1"># try:</span>
    <span class="c1">#     Shell.run(f&#39;tar -C {expanded_dir_path} -cf {name}.tar .&#39;)</span>
    <span class="c1"># except Exception as e:</span>
    <span class="c1">#     print(e.output)</span>
    <span class="c1"># tar_location = Path(</span>
    <span class="c1">#     Shell.map_filename(f&#39;./{name}.tar&#39;).path).as_posix()</span>
    <span class="c1">#</span>
    <span class="n">runtime_directory</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/runtime/&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
    <span class="n">yaml_location</span> <span class="o">=</span> <span class="n">path_expand</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;~/.cloudmesh/workflow/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.yaml&quot;</span><span class="p">)</span>
    <span class="n">Shell</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">)</span>
    <span class="n">expanded_dir_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="c1"># expanded_dir_path = Path(expanded_dir_path).as_posix()</span>

    <span class="c1"># these try excepts are needed in the case of a workflow with</span>
    <span class="c1"># all py files, or all sh files, or all ipynb files</span>
    <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.yaml&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.sh&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.py&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.ipynb&#39;</span><span class="p">):</span>
                <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expanded_dir_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="n">runtime_directory</span><span class="p">)</span>

    <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">runtime_directory</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">.yaml&#39;</span><span class="p">)</span>
    <span class="n">runtime_yaml_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
    <span class="n">Shell</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">runtime_yaml_location</span><span class="p">,</span> <span class="n">yaml_location</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;workflow-example&#39;</span><span class="p">)</span>
    <span class="n">w</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">runtime_yaml_location</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">yaml</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="s1">&#39;/watcher/workflow-example&#39;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Gregor von Laszewski and Jacques Fleischer.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>